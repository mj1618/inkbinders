# Task: State Transitions & Visual Juice

## Overview

Implement the **Transitions** test page (`/test/transitions`) — the polish pass that makes every state-to-state transition feel seamless with visual feedback. This is step 7 of Phase 1, the last feature before the movement playground integration gate.

The Player entity already has 9 states (IDLE, RUNNING, CROUCHING, CROUCH_SLIDING, JUMPING, FALLING, WALL_SLIDING, WALL_JUMPING, DASHING). All the physics and input handling works. What's missing is the *feel* layer: squash-and-stretch deformation, particle effects, landing impact system, and smooth visual blending at state boundaries.

## What to Build

### 1. Particle System (`src/engine/core/ParticleSystem.ts`)

Create a lightweight immediate-mode particle system that the Player (and later, enemies) can emit into. This is a new engine module.

```typescript
interface Particle {
  x: number;
  y: number;
  vx: number;
  vy: number;
  life: number;      // remaining life in seconds
  maxLife: number;    // initial life (for alpha fade)
  size: number;
  color: string;
  gravity: number;    // per-particle gravity (0 for floating dust)
}

class ParticleSystem {
  particles: Particle[];
  emit(config: ParticleEmitConfig): void;  // Spawn N particles with randomized params
  update(dt: number): void;                // Tick all particles, remove dead ones
  render(renderer: Renderer): void;        // Draw all particles
}
```

Keep it simple — no pooling, no textures, just colored rectangles/circles with velocity, gravity, and alpha fade. Cap at ~200 particles max (remove oldest if exceeded).

### 2. Squash-and-Stretch System (modify `Player.ts`)

Add visual deformation to the player rectangle without changing the collision box. The collision box stays the same; only the *rendered* rectangle stretches.

New player properties:
```typescript
// Visual deformation (does NOT affect collision box)
scaleX: number = 1.0;  // horizontal stretch
scaleY: number = 1.0;  // vertical stretch
targetScaleX: number = 1.0;
targetScaleY: number = 1.0;
scaleReturnSpeed: number = 12.0;  // how fast scale returns to 1.0 (per second)
```

Deformation rules (all tunable via params):
- **Jump launch**: scaleX=0.7, scaleY=1.4 (tall and thin) — snaps instantly, returns over ~0.15s
- **Landing (soft)**: scaleX=1.4, scaleY=0.6 (wide and short) — snaps instantly, returns over ~0.12s
- **Landing (hard)**: scaleX=1.6, scaleY=0.5 (wider/shorter) — snaps instantly, returns over ~0.2s
- **Dash start**: scaleX=1.5, scaleY=0.7 (stretched in dash direction) — note: for vertical dashes, swap X/Y
- **Dash end**: scaleX=0.8, scaleY=1.2 (recoil)
- **Wall-slide entry**: scaleX=0.8, scaleY=1.15 (slightly compressed into wall)
- **Wall-jump launch**: scaleX=0.75, scaleY=1.35 (similar to regular jump, slightly wider)
- **Turn-around**: brief scaleX=0.85 for 1-2 frames (compression before direction reversal)
- **Crouch enter**: scaleX=1.2, scaleY=0.7 (squash down)

The visual rect should be drawn centered on the collision box's center (not top-left), so stretching looks symmetrical.

Add these as tunable params to `PlayerParams`:
```typescript
// Squash-stretch parameters
squashStretchEnabled: boolean;
jumpLaunchScaleX: number;      // 0.7
jumpLaunchScaleY: number;      // 1.4
softLandScaleX: number;        // 1.4
softLandScaleY: number;        // 0.6
hardLandScaleX: number;        // 1.6
hardLandScaleY: number;        // 0.5
dashStartScaleX: number;       // 1.5
dashStartScaleY: number;       // 0.7
dashEndScaleX: number;         // 0.8
dashEndScaleY: number;         // 1.2
wallSlideEntryScaleX: number;  // 0.8
wallSlideEntryScaleY: number;  // 1.15
wallJumpScaleX: number;        // 0.75
wallJumpScaleY: number;        // 1.35
turnScaleX: number;            // 0.85
crouchSquashScaleX: number;    // 1.2
crouchSquashScaleY: number;    // 0.7
scaleReturnSpeed: number;      // 12.0
```

### 3. Landing System (modify `Player.ts`)

Currently, landing from FALLING just transitions directly to IDLE or RUNNING. Add a proper landing system:

**Soft landing** — fall duration < `SOFT_LAND_THRESHOLD` frames (default: 12 frames / 0.2s):
- No movement penalty
- Small squash deformation
- Small dust puff (3-5 particles)
- Transition immediately to IDLE/RUNNING

**Hard landing** — fall duration >= `HARD_LAND_THRESHOLD` frames (default: 30 frames / 0.5s):
- Add a new state: `STATE_HARD_LANDING`
- `hardLandRecoveryFrames` parameter (default: 8 frames / ~0.13s) — player cannot move during recovery
- Player can still dash-cancel out of hard landing (this is critical for flow)
- Player can still jump-buffer out of hard landing
- Large squash deformation
- Big dust puff (8-12 particles)
- Brief screen shake (2-3 pixels for 4 frames)

Track fall duration in the FALLING state:
```typescript
fallDurationFrames: number = 0;  // incremented each frame in FALLING state
```

New params:
```typescript
softLandThresholdFrames: number;   // 12
hardLandThresholdFrames: number;   // 30
hardLandRecoveryFrames: number;    // 8
```

### 4. Particle Effects for Transitions

Wire up particle emissions at key transition points:

| Transition | Particles | Details |
|---|---|---|
| **Jump launch** | 4-6 small white/gray | Fan out below feet, slight upward velocity, 0.15s life |
| **Soft landing** | 3-5 small white/gray | Fan out at feet, horizontal spread, 0.12s life |
| **Hard landing** | 8-12 larger white/gray | Big horizontal fan, some bounce, 0.25s life |
| **Turn-around** | 2-3 tiny white | Behind the player in old direction, 0.1s life |
| **Wall-slide contact** | 2-3 tiny white | At wall contact point, drift down, 0.15s life, emit every ~6 frames while sliding |
| **Wall-jump** | 5-7 small white | Fan from wall surface, 0.15s life |
| **Dash start** | 3-4 small at origin | Burst at dash start position, 0.12s life |
| **Dash end** | 4-6 small | Scatter at end position, 0.15s life |
| **Crouch-slide** | 1-2 tiny per ~4 frames | Trail behind the player while sliding, 0.1s life |

Particle colors: Use light grays and whites (`#e5e7eb`, `#d1d5db`, `#f9fafb`) for a paper/ink feel. Keep it subtle — the particles should enhance, not overwhelm.

### 5. Screen Shake Utility (`src/engine/core/ScreenShake.ts`)

Simple screen shake system that offsets the camera:
```typescript
class ScreenShake {
  private intensity = 0;
  private duration = 0;
  private timer = 0;

  shake(intensity: number, durationFrames: number): void;
  update(): { offsetX: number; offsetY: number };  // Returns per-frame offset
}
```

Apply the offset in the renderer or camera during the render pass. Used for hard landing (2-3px, 4 frames) and later for combat hitstop.

### 6. Transition Audit & Edge Smoothing

Review and fix these specific transition edges in the state machine:

- **IDLE → RUNNING**: Currently instant. Add turn-around particles when velocity sign changes. Trigger turn squash if `facingRight` flips.
- **RUNNING → IDLE**: Ensure deceleration slide doesn't pop. Already works but verify no visual hitch.
- **RUNNING/IDLE → JUMPING**: Add jump launch squash + dust particles in JUMPING.enter.
- **FALLING → IDLE/RUNNING**: Replace with landing system (soft/hard). This is the biggest change.
- **FALLING → WALL_SLIDING**: Add wall contact squash + particles.
- **WALL_SLIDING → WALL_JUMPING**: Add wall-jump squash + wall particles.
- **WALL_JUMPING → JUMPING**: Already smooth (just check no visual pop).
- **Any → DASHING**: Add dash start squash + particles.
- **DASHING → Any**: Add dash end recoil squash + particles.
- **RUNNING → CROUCH_SLIDING**: Add crouch squash.
- **CROUCH_SLIDING → CROUCHING**: Verify smooth (already friction-based).

### 7. Test Page (`/test/transitions`)

Replace the stub with a full test page. The test level should be designed to trigger every transition type:

**Test Level Layout:**
- Wide floor for ground movement (run, turn, stop, crouch-slide)
- Series of step-up platforms (varying heights: 60px, 120px, 200px, 300px) for testing soft vs hard landing
- A tall drop (300px+) for guaranteed hard landing
- Tall walls on both sides for wall-slide/wall-jump chains
- Narrow chimney (60px gap) for wall-jump ping-pong
- Open space for dash testing in all 8 directions
- Moving between all areas should be fluid

**Debug Panel Sections (collapsible):**
1. **Squash & Stretch** — toggle on/off + sliders for all scale values + scaleReturnSpeed
2. **Landing** — sliders for soft/hard thresholds, recovery frames
3. **Particles** — toggle on/off, particle count multiplier slider (0.5x - 2x)
4. **Screen Shake** — toggle on/off, intensity multiplier slider
5. **State Info** — (read-only) current state, previous state, time in state, fall duration, active deformations

**Debug Overlays (on canvas):**
- Current squash-stretch values (scaleX, scaleY) shown near player
- Collision box outline (separate from visual rect to show the deformation difference)
- Fall duration counter when falling
- Landing type indicator ("SOFT" / "HARD" text flash on landing)
- Particle count
- State transition log (last 5 transitions with timestamps, shown in corner)

**Pass Criteria (display on page):**
1. Jump launch shows visible squash-stretch (tall-thin → returns to normal)
2. Landing from short fall shows soft land squash + small dust puff
3. Landing from tall fall shows hard land with recovery frames + big squash + screen shake
4. Hard landing can be dash-cancelled or jump-buffered out of
5. Turn-around shows compression + dust particles
6. Wall-slide shows ongoing dust particles at wall contact
7. Wall-jump shows launch squash + wall particles
8. Dash start/end show appropriate deformation + particles
9. All squash-stretch returns smoothly to (1,1) — no stuck deformations
10. Collision box remains unchanged despite visual deformation

## Files to Create/Modify

### Create:
- `src/engine/core/ParticleSystem.ts` — Particle system
- `src/engine/core/ScreenShake.ts` — Screen shake utility

### Modify:
- `src/engine/entities/Player.ts` — Add squash-stretch, landing system, particle emission, STATE_HARD_LANDING, fall duration tracking
- `src/engine/core/index.ts` — Export new modules
- `src/app/test/transitions/page.tsx` — Replace stub with full test page
- `src/lib/testStatus.ts` — Update transitions status to "in-progress"

## Important Implementation Notes

1. **Collision box NEVER changes** due to squash-stretch. The visual rect is derived from the collision box center + scale, but physics uses the unscaled box.

2. **Player.render() is the only place squash-stretch matters.** Calculate the visual rect from the collision center:
   ```typescript
   const cx = pos.x + this.size.x / 2;
   const cy = pos.y + this.size.y / 2;
   const visualW = this.size.x * this.scaleX;
   const visualH = this.size.y * this.scaleY;
   renderer.fillRect(cx - visualW/2, cy - visualH/2, visualW, visualH, bodyColor);
   ```

3. **The ParticleSystem should be passed to the Player** (or available globally via Engine). The Player emits particles by calling `particleSystem.emit(...)` at transition points. The ParticleSystem is updated and rendered by the Engine/test page, not by the Player.

4. **Don't over-do the visual effects.** This is a hand-inked art style — particles should be small, fast-fading, and subtle. Think ink splatter, not fireworks.

5. **Squash-stretch return uses lerp**, not instant snap-back:
   ```typescript
   this.scaleX += (this.targetScaleX - this.scaleX) * this.scaleReturnSpeed * dt;
   this.scaleY += (this.targetScaleY - this.scaleY) * this.scaleReturnSpeed * dt;
   ```
   Target is always (1.0, 1.0). On transition events, snap scaleX/scaleY to the deformation values, then they return to 1.0 over time.

6. **The test page should use the existing GameCanvas + DebugPanel pattern** from the dash test page. Follow the same code structure.

7. **Keep the particle system in `src/engine/core/`** since it's a core engine system, not specific to any entity.

8. **STATE_HARD_LANDING** should be added to the player state names and registered with the state machine. It's a brief recovery state that only blocks movement — dash-cancel and jump-buffer still work.

9. **Existing test pages should NOT be modified.** The new systems (squash-stretch, particles) should be opt-in. The Player should check `this.params.squashStretchEnabled` before applying deformations, and particle emission should only happen if a ParticleSystem reference is set on the player.

10. **Export the ParticleSystem and ScreenShake** from `src/engine/core/index.ts` so other test pages can use them later.

---

## Completion Summary

### Files Created
- `src/engine/core/ParticleSystem.ts` — Lightweight immediate-mode particle system with emit(), update(), render(). Supports configurable velocity, gravity, alpha fade, size, color, count multiplier. Capped at 200 particles.
- `src/engine/core/ScreenShake.ts` — Screen shake utility with intensity decay over time. Returns per-frame camera offsets. Supports enabled toggle and intensity multiplier.

### Files Modified
- `src/engine/entities/Player.ts` — Major changes:
  - Added 17 squash-stretch parameters to PlayerParams (jumpLaunchScaleX/Y, softLandScaleX/Y, hardLandScaleX/Y, dashStartScaleX/Y, dashEndScaleX/Y, wallSlideEntryScaleX/Y, wallJumpScaleX/Y, turnScaleX, crouchSquashScaleX/Y, scaleReturnSpeed)
  - Added 3 landing parameters (softLandThresholdFrames, hardLandThresholdFrames, hardLandRecoveryFrames)
  - Added squashStretchEnabled flag (default: false for opt-in)
  - Added STATE_HARD_LANDING state with recovery timer, dash-cancel and jump-buffer support
  - Added fallDurationFrames tracking in FALLING state
  - Added scaleX/scaleY visual deformation with lerp return to (1,1)
  - Added particleSystem and screenShake optional references
  - Wired particle emissions to all transition points: jump launch, soft landing, hard landing, turn-around, wall-slide entry, wall-slide ongoing, wall-jump, dash start, dash end, crouch-slide trail
  - Visual rect rendering uses squash-stretch centered on collision box
  - Landing type indicator (SOFT/HARD) for debug overlay
- `src/engine/core/index.ts` — Added exports for ParticleSystem, ScreenShake, Particle, ParticleEmitConfig
- `src/app/test/transitions/page.tsx` — Replaced stub with full test page featuring:
  - Test level with wide floor, step-up platforms (60/120/200/300px), tall drop, walls, narrow chimney, floating platform
  - Debug panel with collapsible sections: Squash & Stretch, Landing, Particles, Screen Shake, Ground Movement, Jumping, Dash
  - Debug overlays: collision box, visual rect outline, squash-stretch values, fall duration, landing type flash, state transition log
  - All squash-stretch and landing parameters tunable via sliders
  - Particle count multiplier and screen shake intensity multiplier
  - Toggle switches for squash-stretch, particles, screen shake, and debug overlays
- `src/lib/testStatus.ts` — Updated transitions status from "not-started" to "in-progress"

### Key Design Decisions
- squashStretchEnabled defaults to false (opt-in) — existing test pages are unaffected
- Particle emission only happens when particleSystem reference is set (null by default)
- Collision box is NEVER affected by squash-stretch — only the visual rect changes
- Hard landing recovery blocks movement but allows dash-cancel and jump-buffer for flow
- Particle colors use subtle ink-style whites/grays (#e5e7eb, #d1d5db, #f9fafb)
- Screen shake uses decaying intensity for natural feel

### Verification
- `npx tsc --noEmit` passes with zero errors
- `npx next build` succeeds, all 27 pages generated including /test/transitions

---

## Review (agent: 0caddbdd)

### Files Reviewed
- `src/engine/core/ParticleSystem.ts` — Clean. Correct particle lifecycle, alpha fade, max cap with oldest-removal. No issues.
- `src/engine/core/ScreenShake.ts` — Clean. Frame-based timer with decaying intensity. Correct.
- `src/engine/entities/Player.ts` — Thorough implementation. All squash-stretch params wired, HARD_LANDING state correct (dash-cancel + jump-buffer work), fall duration tracking correct.
- `src/engine/core/index.ts` — Exports correct.
- `src/app/test/transitions/page.tsx` — Well-structured test page following existing patterns. All sliders wired. Debug overlays comprehensive.
- `src/lib/testStatus.ts` — Status correctly updated.

### Issues Found & Fixed

1. **Bug: `emitFeetParticles` angle math** (`Player.ts:258-259`)
   - Particle emission was centered around `-Math.PI` (pointing left in screen space) instead of `-Math.PI/2` (pointing upward). This caused all foot-dust particles to spray to the left instead of upward from the player's feet.
   - **Fix**: Changed `angleMin: -Math.PI - spreadAngle / 2` → `angleMin: -Math.PI / 2 - spreadAngle / 2` (and same for angleMax).

### No Issues
- ParticleSystem, ScreenShake, core/index.ts, testStatus.ts — all clean.

---

## Second Review (agent: 75b3acd7)

### Additional Issues Found & Fixed

1. **Bug: `resetParams` disables squash-stretch** (`transitions/page.tsx`)
   - The page initializes with `squashStretchEnabled: true` but `resetParams` restored `DEFAULT_PLAYER_PARAMS` which has `squashStretchEnabled: false`. Pressing "Reset Params" would disable the main feature being tested.
   - **Fix**: Changed resetParams to spread `{ ...DEFAULT_PLAYER_PARAMS, squashStretchEnabled: true }` so the page's default behavior is preserved.

### Verified Clean
- All code from first review verified correct (particle angle fix, all squash-stretch params wired, HARD_LANDING state with dash-cancel/jump-buffer, fall duration tracking).
- `npx tsc --noEmit` passes after fix.
