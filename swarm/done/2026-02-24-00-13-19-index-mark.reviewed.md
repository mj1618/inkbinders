# Task: Index Mark — Living Waypoint Teleportation

## Overview

Implement the **Index Mark** ability and its test page (`/test/index-mark`). This is the fourth and final editing ability (Phase 2, step 12). While Margin Stitch creates passages, Redaction erases obstacles, and Paste-Over changes surfaces, Index Mark **creates teleportation waypoints** — the player bookmarks locations in the world and can instantly jump between them.

The metaphor: the player places colored bookmark tabs on the manuscript pages. Each tab marks a spot. By focusing on a tab, the player can flip the pages and appear at that location instantly — like jumping between bookmarks in a massive tome.

Index Mark is a navigation/utility ability rather than a physics-modifying one. It completes the editing ability suite and sets up the pattern for multi-room navigation that will be critical in the full game.

**Dependencies:**
- Margin Stitch must be complete (establishes ability system patterns, input bindings) ✅
- Redaction should be complete (establishes aim-direction targeting) ✅
- Paste-Over is NOT a blocker — Index Mark is independent of surface types
- The Camera system must support instant position changes (`snapTo`) ✅

## What to Build

### 1. Index Mark System (`src/engine/abilities/IndexMark.ts`)

The Index Mark ability works in two modes:

**Placing a mark:** Press the ability key to drop a bookmark at the player's current position. The mark appears as a glowing tab/ribbon at that world position.

**Teleporting to a mark:** Hold a directional key + press ability key to teleport to the mark in that direction. If the player has multiple marks placed, the system finds the mark most closely aligned with the aimed direction.

Alternatively (simpler and more intuitive): **Cycle + Teleport.** The player cycles through placed marks (highlighted on screen) by pressing the ability key briefly, then holds it to teleport. This avoids directional confusion.

**Final design: Press to place, Hold to teleport.**
- **Short press** (< 10 frames / ~167ms): Place a new mark at the current position, OR if at max marks, replace the oldest mark.
- **Hold** (≥ 10 frames): Show mark selection UI. While holding, use Left/Right to cycle through marks. On release, teleport to the selected mark.
- This gives one button for the full workflow: tap to place, hold to teleport.

```typescript
export interface IndexMarkParams {
  /** Maximum number of marks the player can have placed at once */
  maxMarks: number;
  /** Hold threshold in frames before entering teleport mode */
  holdThreshold: number;
  /** Cooldown after teleporting before another teleport (seconds) */
  teleportCooldown: number;
  /** Duration of the teleport visual effect (seconds) — the actual teleport is instant */
  teleportVisualDuration: number;
  /** Whether placed marks expire over time. false = permanent until replaced */
  marksExpire: boolean;
  /** Mark lifetime in seconds (only if marksExpire is true) */
  markLifetime: number;
  /** Brief invincibility frames after teleporting (prevents landing in danger) */
  teleportIFrames: number;
  /** Whether the ability is unlocked/available */
  enabled: boolean;
}

export const DEFAULT_INDEX_MARK_PARAMS: IndexMarkParams = {
  maxMarks: 4,                  // 4 bookmarks — enough for interesting routing
  holdThreshold: 10,            // ~167ms hold to enter teleport mode
  teleportCooldown: 1.5,        // 1.5s between teleports — prevents spam
  teleportVisualDuration: 0.3,  // 0.3s for the visual whoosh
  marksExpire: false,           // Marks are permanent by default (can toggle in debug)
  markLifetime: 30.0,           // 30s lifetime when expiry is enabled
  teleportIFrames: 12,          // 0.2s of invincibility post-teleport
  enabled: true,
};

export interface PlacedMark {
  /** Unique ID */
  id: string;
  /** World position where the mark was placed */
  position: Vec2;
  /** Color index (0-3) for visual distinction — cycles through a palette */
  colorIndex: number;
  /** Timestamp of when the mark was placed (for ordering and expiry) */
  placedAt: number;
  /** Remaining lifetime in seconds (only relevant if marksExpire is true) */
  remainingLife: number;
  /** The player's grounded state when the mark was placed (for safe teleport landing) */
  wasGrounded: boolean;
}

export interface TeleportState {
  /** Whether the player is in teleport-selection mode (holding the ability key) */
  selecting: boolean;
  /** Index of the currently highlighted mark in the marks array */
  selectedIndex: number;
  /** Frames the ability key has been held */
  holdFrames: number;
  /** Whether a teleport is currently in visual transition (player has teleported but visual is playing) */
  visualActive: boolean;
  /** Remaining visual effect duration */
  visualTimer: number;
  /** Origin position of the teleport (for visual trail) */
  teleportOrigin: Vec2 | null;
  /** Destination position of the teleport */
  teleportDestination: Vec2 | null;
}

export class IndexMark {
  params: IndexMarkParams;

  /** All currently placed marks */
  marks: PlacedMark[] = [];

  /** Teleport selection / animation state */
  teleportState: TeleportState;

  /** Cooldown timer (seconds remaining) */
  cooldownTimer: number = 0;

  /** Counter for generating unique IDs */
  private nextId: number = 0;

  /** Color palette for mark colors */
  static readonly MARK_COLORS = ['#f59e0b', '#3b82f6', '#10b981', '#ef4444']; // amber, blue, green, red

  /** Whether the ability can place a new mark right now */
  get canPlace(): boolean {
    return this.params.enabled && !this.teleportState.selecting;
  }

  /** Whether the ability can initiate teleport selection */
  get canTeleport(): boolean {
    return (
      this.params.enabled &&
      this.marks.length > 0 &&
      this.cooldownTimer <= 0 &&
      !this.teleportState.visualActive
    );
  }

  /**
   * Handle ability key press start.
   * Call when the ability key is first pressed.
   */
  onKeyDown(): void;

  /**
   * Handle ability key held each frame.
   * Increments hold counter, enters teleport mode after threshold.
   */
  onKeyHeld(input: InputManager): void;

  /**
   * Handle ability key release.
   * If hold was short: place a mark.
   * If hold was long (teleport mode): execute teleport to selected mark.
   */
  onKeyUp(playerPosition: Vec2, playerGrounded: boolean): { action: 'place' | 'teleport' | 'cancel'; targetPosition?: Vec2 };

  /**
   * Place a mark at the given position.
   * If at maxMarks, replaces the oldest mark.
   */
  placeMark(position: Vec2, grounded: boolean): PlacedMark;

  /**
   * Execute teleport to the selected mark.
   * Returns the destination position (caller must move the player).
   */
  executeTeleport(): Vec2 | null;

  /**
   * Cycle mark selection left/right during teleport selection mode.
   */
  cycleSelection(direction: -1 | 1): void;

  /**
   * Remove a specific mark by ID.
   */
  removeMark(id: string): void;

  /**
   * Clear all marks.
   */
  clearAllMarks(): void;

  /**
   * Update timers (cooldown, mark expiry, teleport visual).
   * Call every physics frame.
   */
  update(dt: number): void;

  /**
   * Render all marks, teleport selection UI, and teleport visual effects.
   * Call during render.
   */
  render(ctx: CanvasRenderingContext2D, camera: Camera): void;

  /**
   * Render screen-space UI elements (mark inventory, cooldown indicator).
   * Call during screen-space render.
   */
  renderUI(ctx: CanvasRenderingContext2D, playerScreenPos: Vec2): void;
}
```

### 2. Teleport Mechanics

When the player teleports:
1. The player's position is instantly set to the mark's position
2. The player's velocity is zeroed out (clean landing)
3. If the mark was placed while grounded, the player is grounded at the destination
4. If the mark was placed in the air, the player starts falling at the destination
5. Brief invincibility frames prevent instant death at the destination
6. The camera snaps to the new position (with a brief smooth transition if the distance is small, instant snap if large)
7. A visual trail connects the origin and destination briefly

**Camera handling on teleport:**
- If teleport distance > 400px: camera snaps instantly to destination (long-distance jump)
- If teleport distance ≤ 400px: camera does a fast lerp (3x normal follow speed for ~0.3s)

### 3. Input Binding

Index Mark uses `Ability3`:

Add to `InputManager.ts`:
```typescript
Ability3: "ability3",  // Index Mark
```

Default key binding: `r` key.

The test page wires Ability3 to the IndexMark system. The input handling is more complex than other abilities because it distinguishes short press from hold:

```typescript
// In test page update:
if (input.isPressed(InputAction.Ability3)) {
  indexMark.onKeyDown();
}
if (input.isHeld(InputAction.Ability3)) {
  indexMark.onKeyHeld(input);
}
// Need to detect key release — check if was held last frame but not this frame
if (wasAbility3Held && !input.isHeld(InputAction.Ability3)) {
  const result = indexMark.onKeyUp(playerPosition, playerGrounded);
  if (result.action === 'teleport' && result.targetPosition) {
    player.position.x = result.targetPosition.x;
    player.position.y = result.targetPosition.y;
    player.velocity.x = 0;
    player.velocity.y = 0;
    // Handle camera snap
  }
}
```

**Note:** The InputManager has `isPressed()` (just pressed this frame) and `isHeld()` (currently down). We also need to detect release. Check if InputManager already tracks "just released" — if it has a `released` set, use that. If not, the test page can track the previous frame's held state.

Looking at the InputManager code, there IS a `released` set (`private released = new Set<InputAction>()`), but check if there's an `isReleased()` method exposed. If not, add one — it follows the same pattern as `isPressed()` and `isHeld()`.

### 4. Visual Design

Index Mark visuals should evoke bookmark tabs and ribbon markers — colorful tabs poking out of the world with a handmade, inked quality:

**Placed mark visuals:**
- A vertical ribbon/tab shape, approximately 8px wide × 24px tall
- Color-coded: amber (#f59e0b), blue (#3b82f6), green (#10b981), red (#ef4444) — cycling through
- Subtle glow/pulse around the mark (oscillating alpha, 40%-70%)
- A small number label (1, 2, 3, 4) inside or above the tab
- Thin ink line connecting the tab to the ground/surface where it was placed
- Tiny particle sparkles drifting upward from the mark (1-2 per second, mark color, very subtle)

**Teleport selection mode (while holding ability key):**
- All marks become more prominent: glow increases, size scales up slightly
- The selected mark gets a bright pulsing ring around it
- A beam/line from the player to the selected mark (dashed, in the mark's color, 60% opacity)
- Left/right arrows appear near the player showing cycle controls
- A "TELEPORT" label above the selected mark
- The screen subtly desaturates everything except the marks (10% desaturation, very subtle)

**Teleport visual (0.3s):**
- At the origin: burst of ink particles in the mark's color, expanding ring
- Along the path: a brief ink trail/streaks connecting origin to destination
- At the destination: converging particles from the edges toward the player, a quick "pop" flash
- Screen flash (very brief, 2-3 frames, white at 10% opacity)

**Mark placement visual:**
- A quick downward "stamp" animation: the tab drops from above and sticks
- Small ink splatter particles around the base
- Brief flash of the mark's color

**Mark removal/replacement visual:**
- The old mark dissolves: ink drips downward and fades
- Then the new mark stamps in at the new location

**Cooldown indicator:**
- Small circular cooldown overlay near the player (like other abilities)
- Mark color, fills clockwise as cooldown progresses

**Mark inventory (screen-space HUD, top-right):**
- Row of small colored squares showing placed marks
- Empty slots shown as dark outlines
- Active/selected mark has a bright border
- Each shows a tiny distance readout (e.g., "120px" in small text)

**Colors:**
- Mark 1: `#f59e0b` (amber)
- Mark 2: `#3b82f6` (blue)
- Mark 3: `#10b981` (green)
- Mark 4: `#ef4444` (red)
- Selection beam: mark color at 60%
- Teleport trail: mark color transitioning to white
- Placement particles: mark color + `#fbbf24` (lighter amber sparkles)
- Removal particles: mark color fading to `#6b7280` (gray)

### 5. Test Page (`/test/index-mark`)

Replace the stub with a full test page.

**Test Level Layout (3840×1080, scrolling — same size as movement playground):**

The level is designed as a series of distinct areas that are connected but require backtracking or long traversal to move between. This makes teleportation genuinely useful, not just a gimmick.

```
Area 1: Starting Area (x: 0–960)
┌──────────────────────────────────────────────────────────────┐
│  START                                                        │
│  ═══════                                                      │
│                                                               │
│           ╔═══╗                                               │
│           ║   ║  Tall tower                                   │
│           ║   ║  (platform                                    │
│   ┌───┐   ║   ║   staircase)                                 │
│   │   │   ║   ║                                               │
│   └───┘   ║   ║          ┌─────┐                              │
│           ╚═══╝          │GOAL │  Only reachable by           │
│                          │  A  │  teleporting from tower top  │
│                          └─────┘                              │
│  ══════════════════════════════════════════════════════════    │
└──────────────────────────────────────────────────────────────┘

Area 2: Hazard Corridor (x: 960–1920)
┌──────────────────────────────────────────────────────────────┐
│                                                               │
│                    (long gap — no floor)                       │
│                                                               │
│  ═══    ═══    ═══    ═══    ═══    ═══    ═══                │
│  Platform sequence with wide gaps — too wide to jump across   │
│  Player must: place mark on one side, fall down, cross below, │
│  climb up, place mark on other side, then teleport back       │
│  to retrieve an item / reach a goal                           │
│                                                               │
│  ═══════════════════════════════  ════════════════════════     │
│  lower ground                    lower ground                  │
│                   (pit)                                        │
│  ═══════════════════════════════════════════════════════════   │
└──────────────────────────────────────────────────────────────┘

Area 3: Vertical Shaft (x: 1920–2880)
┌──────────────────────────────────────────────────────────────┐
│  ┌──┐          GOAL C (top)                            ┌──┐  │
│  │  │   ═════════════════════                          │  │  │
│  │  │                                                  │  │  │
│  │  │        ═══════                                   │  │  │
│  │  │                    ═══════                       │  │  │
│  │  │   ═══════                                        │  │  │
│  │  │              ═══════                              │  │  │
│  │  │                        ═══════                   │  │  │
│  │  │   Zigzag platforms — wall-jump up the shaft      │  │  │
│  │  │   Mark the bottom, reach the top, teleport       │  │  │
│  │  │   back down to save the climb                    │  │  │
│  └──┘                                                  └──┘  │
│  ═══════════════════════════════════════════════════════════   │
└──────────────────────────────────────────────────────────────┘

Area 4: Multi-Mark Puzzle (x: 2880–3840)
┌──────────────────────────────────────────────────────────────┐
│                                                               │
│  ┌───┐         ┌───┐         ┌───┐         ┌───┐            │
│  │ A │         │ B │         │ C │         │ D │  GOAL D     │
│  │   │  wall   │   │  wall   │   │  wall   │   │            │
│  │   │  ████   │   │  ████   │   │  ████   │   │            │
│  │   │         │   │         │   │         │   │            │
│  └───┘         └───┘         └───┘         └───┘            │
│                                                               │
│  Four isolated chambers separated by tall walls.              │
│  Each has a platform and a switch/goal zone.                  │
│  Player must place a mark in each chamber (max 4 marks),     │
│  then teleport between them to activate all zones             │
│  within a time window (proof-of-concept for puzzles).         │
│                                                               │
│  ═══════════════════════════════════════════════════════════   │
└──────────────────────────────────────────────────────────────┘
```

**Level elements in detail:**

1. **Starting area** (x: 0–960):
   - Ground floor spanning the area
   - A tower of stacked platforms on the left (staircase pattern, 5-6 platforms going up)
   - Goal A: an isolated floating platform at y: ~200 that can only be reached by placing a mark at the tower top and teleporting there (the gap is too wide to jump)
   - This teaches the basic: place mark → move to a position you can't normally reach by jumping → teleport

2. **Hazard corridor** (x: 960–1920):
   - Upper level: a series of small platforms with wide gaps (wider than jump distance, ~200px gaps)
   - Lower level: continuous ground floor ~300px below
   - A pit between the upper and lower ground in the middle
   - Goal B: on the far-right upper platform
   - The player must: mark a platform, drop to the lower level, walk across, climb back up, then optionally teleport to retrieve their earlier position
   - This tests teleporting as backtrack prevention

3. **Vertical shaft** (x: 1920–2880):
   - Two tall walls creating a shaft
   - Zigzag platforms for wall-jumping upward
   - Goal C at the top of the shaft
   - Player marks the bottom, climbs to the top, can teleport back down instantly
   - Tests vertical teleportation and camera snap behavior

4. **Multi-mark puzzle** (x: 2880–3840):
   - Four isolated chambers separated by walls too tall to jump over (no wall-jump surfaces on the separating walls — make them too thin or place ceilings to block)
   - Each chamber has a "goal zone" (colored rectangle) that activates when the player stands in it
   - Goal D: light up all 4 zones within 15 seconds
   - Player must place a mark in each chamber (uses all 4 marks), then quickly teleport between them
   - A visible timer starts when the first zone is activated
   - Tests max mark usage and rapid teleportation

5. **Ground floor** — continuous normal floor throughout the level (with gaps for the vertical shaft entrance and hazard corridor pit)

6. **Boundary walls + ceiling** — standard level bounds (3840×1080)

**Goal Zones (simple interactive elements):**
- Colored rectangles on the ground in each area
- Turn from dark/dim to bright when the player stands in them
- Goal A–C: simple "reached" indicators
- Goal D (multi-mark puzzle): all 4 must be activated within a time window

```typescript
interface GoalZone {
  id: string;
  rect: Rect;
  color: string;          // dim color when inactive
  activeColor: string;    // bright color when activated
  activated: boolean;
  activatedAt: number;    // timestamp for multi-mark timing
  label: string;
}
```

**Debug Overlays (on canvas):**
- Player hitbox (cyan)
- All mark positions (colored tab icons with numbers)
- Mark placement radius indicator (subtle)
- Teleport selection beam (when holding ability key)
- Teleport trail/particles (during teleport visual)
- Goal zone outlines and activation state
- Multi-mark puzzle timer (when active)
- Cooldown indicator near player
- Current mark count / max
- FPS counter, velocity, player state

**Debug Panel Sections (collapsible):**

1. **Index Mark Info** (always visible):
   - Marks placed: count / max
   - Mark list: position, color, age (or remaining life if expiry enabled)
   - Teleport state: READY / SELECTING / COOLDOWN / VISUAL
   - Cooldown timer (if on cooldown)
   - Selected mark (during teleport selection)
   - Teleport distance (to selected mark)
   - Goals reached: A ☐ B ☐ C ☐ D ☐

2. **Index Mark Params** (expanded by default):
   | Parameter | Min | Max | Step | Default | Description |
   |-----------|-----|-----|------|---------|-------------|
   | Max Marks | 1 | 8 | 1 | 4 | Maximum placed marks |
   | Hold Threshold | 4 | 30 | 1 | 10 | Frames before teleport mode |
   | Teleport Cooldown | 0.0 | 5.0 | 0.25 | 1.5 | Seconds between teleports |
   | Visual Duration | 0.1 | 1.0 | 0.05 | 0.3 | Teleport effect duration |
   | Marks Expire | toggle | — | — | false | Whether marks have a lifetime |
   | Mark Lifetime | 5.0 | 120.0 | 5.0 | 30.0 | Seconds before mark expires (if enabled) |
   | Teleport I-Frames | 0 | 30 | 1 | 12 | Invincibility frames after teleport |

3. **Player State** (collapsed by default):
   - Current state, velocity, position, grounded, dash status
   - All movement params as sliders

4. **Controls** (expanded by default):
   - Reset Player button (respawn at start)
   - Clear All Marks button
   - Reset Params button
   - Debug overlay toggle
   - Mark labels toggle
   - Goal zone reset button (re-dim all goals)
   - Puzzle timer: [value] / 15s (when active)

**Pass Criteria (display on page):**
1. Short press of R places a mark at the player's current position
2. Mark appears as a colored tab with number label at the placed position
3. Holding R enters teleport selection mode — marks become highlighted
4. Left/Right arrows cycle through marks during selection mode
5. Releasing R after selection teleports the player to the selected mark
6. Player position is instantly set to the mark's position on teleport
7. Player velocity is zeroed on teleport (clean arrival)
8. Camera handles teleport correctly (snap for long distance, smooth for short)
9. Brief invincibility after teleporting (i-frames)
10. Cooldown prevents immediate re-teleport
11. Mark placement works from any movement state (IDLE, RUNNING, JUMPING, etc.)
12. Teleport activates from any movement state without breaking movement flow
13. When at max marks (4), placing a new mark replaces the oldest
14. Mark inventory HUD shows all placed marks with colors
15. Goal A reachable via teleport (place mark at tower top, teleport to floating platform)
16. Goal D puzzle: activate all 4 zones within 15 seconds using 4 marks + rapid teleport

Auto-detection for criteria:
- 1: `marks.length` increases after short press
- 2: Visual check (mark tab rendered at position)
- 3: `teleportState.selecting === true` after holding ability key for 10+ frames
- 4: `teleportState.selectedIndex` changes when pressing Left/Right during selection
- 5: Player position changes to mark position on key release during selection
- 6: `player.position` matches selected mark position within 1px
- 7: `player.velocity.x === 0 && player.velocity.y === 0` immediately after teleport
- 8: Camera position matches player position within 1 second of teleport
- 9: Track a `teleportIFramesRemaining` counter > 0 after teleport
- 10: Teleport fails (returns 'cancel') when `cooldownTimer > 0`
- 11: Mark placed while player state is RUNNING, JUMPING, etc. (track source state)
- 12: Teleport succeeds while player was in various states
- 13: `marks.length === maxMarks` and oldest mark removed after new placement
- 14: Visual check (HUD elements rendered)
- 15: Player position reaches Goal A rect
- 16: All 4 goal zones activated within 15 seconds of first activation

**Keyboard Controls:**
| Key | Action |
|-----|--------|
| Arrow Left/Right | Move (also cycles marks during teleport selection) |
| Arrow Up / Z / Space | Jump |
| Arrow Down | Crouch |
| X / Shift | Dash |
| R | Index Mark (tap = place, hold = teleport selection, release = teleport) |
| D | Toggle debug overlays |

## Files to Create

- `src/engine/abilities/IndexMark.ts` — Index Mark ability system

## Files to Modify

- `src/engine/abilities/index.ts` — Export IndexMark
- `src/engine/input/InputManager.ts` — Add `Ability3` action, bind to `r` key. Also add `isReleased()` method if not present (check if a `released` set is exposed — the private `released` set exists but may not have a public accessor)
- `src/app/test/index-mark/page.tsx` — Full test page (replace stub)
- `src/lib/testStatus.ts` — Update index-mark status to `'in-progress'`

## Important Implementation Notes

1. **Zero flow interruption for mark placement.** Tapping R to place a mark is instant — no state change, no animation delay, no pause. The player keeps running/jumping/dashing. The visual "stamp" plays asynchronously.

2. **Teleport selection is the one exception to zero-interruption.** Holding R puts the player into a brief selection mode. During this mode the player can still move (they're holding R, not frozen), but the selection UI is overlaid. On release, the teleport is instant. The hold duration is very short (~167ms) so it barely interrupts flow.

3. **This is an ability, not a player state.** Like all editing abilities, Index Mark does NOT add new player states to the state machine. The `teleportState` is tracked entirely within the `IndexMark` class. The player state machine continues running normally. The teleport itself is just a position/velocity override applied by the test page.

4. **Camera behavior on teleport is critical.** A bad camera response ruins the feel. For long teleports (>400px), snap the camera instantly — the player expects a "cut." For short teleports (≤400px), use a very fast lerp (triple the normal follow speed for 0.3s then return to normal). The test page should temporarily increase `camera.followSpeed` during the teleport visual duration.

5. **Mark persistence model for the test page.** Marks are local state in the IndexMark instance. They persist until manually cleared, replaced (oldest-first when at max), or expired (if the expiry toggle is on). In the real game, marks will persist across rooms via Convex. For now, they're memory-only.

6. **The multi-mark puzzle is a test of the system, not a polished puzzle.** Keep it simple: 4 rectangular goal zones, a visible timer, and the requirement to stand in each one. No complex triggers or sequencing. Just "activate all 4 within 15 seconds."

7. **Teleport destination safety.** When teleporting, the player should arrive at the exact mark position. If the mark was placed while grounded, the player should be grounded at the destination (set `player.grounded = true` and let the next collision pass confirm). If the mark was placed in the air, the player will start falling — this is intended (you bookmarked a mid-air position, you arrive in mid-air).

8. **`isReleased()` on InputManager.** The InputManager already tracks a `released` set internally. If there's no public `isReleased(action)` method, add one following the same pattern as `isPressed()` and `isHeld()`. This is needed for detecting the ability key release that triggers the teleport.

9. **Use the existing ParticleSystem** for mark placement, teleport, and expiry particles. Create a ParticleSystem instance in the test page.

10. **Follow the existing test page pattern.** Use `GameCanvas`, `DebugPanel`, `Slider` components. The level is 3840×1080 (same as movement playground), so use the Camera with `bounds` set for the full level and `follow()` for smooth tracking.

11. **The level uses the same scale as movement playground** (3840×1080). This is intentional — it's large enough that teleportation is genuinely useful. The camera follows the player smoothly. All 4 areas are connected by a ground floor so the player can walk between them traditionally.

12. **Mark color cycling:** Mark 1 = amber, Mark 2 = blue, Mark 3 = green, Mark 4 = red. When a mark is replaced, the new mark takes the color of the slot it fills (the oldest mark's color index). This keeps the colors consistent and predictable.

## Design Decisions (Pre-settled)

1. **Tap to place, hold to teleport.** One button for the full workflow. Placing is instant (tap), teleporting requires a brief hold to enter selection mode. This is intuitive and prevents accidental teleports.
2. **4 marks maximum.** Enough for the multi-mark puzzle and interesting routing, but not so many that management becomes tedious.
3. **Cycle selection with Left/Right.** During teleport selection mode, the player uses the existing movement keys to cycle through marks. Simple and requires no new input bindings.
4. **Marks don't expire by default.** Permanent bookmarks are more useful and less stressful. The expiry toggle is there for testing and for the eventual real game where mark management creates resource tension.
5. **Oldest-first replacement.** When at max marks, the oldest mark is automatically replaced. No manual deletion needed (though Clear All is available). This keeps the flow moving.
6. **Velocity zeroed on teleport.** Clean arrival — no residual momentum from the teleport origin. The player starts fresh at the destination. This is simpler and prevents confusing physics interactions.
7. **Brief i-frames after teleport.** Prevents the "teleport into danger" frustration. 12 frames (0.2s) is enough to react but not enough to exploit.
8. **Visual trail between origin and destination.** A brief ink trail during the 0.3s visual duration gives spatial context — the player sees where they came from. This is especially important for long-distance teleports.

## Verification

- [ ] `npx tsc --noEmit` passes with zero errors
- [ ] `npm run build` succeeds
- [ ] Navigate to `/test/index-mark` — canvas renders with test level and player
- [ ] Tapping R places a mark at the player's position with a colored tab visual
- [ ] Mark appears in the HUD inventory (top-right)
- [ ] Holding R for ~167ms enters teleport selection mode (marks highlight)
- [ ] Left/Right cycles through placed marks during selection
- [ ] Releasing R while in selection mode teleports the player to the selected mark
- [ ] Player position is set to the mark's position on teleport
- [ ] Player velocity is zeroed after teleport
- [ ] Camera snaps for long-distance teleports (>400px)
- [ ] Camera does fast smooth follow for short-distance teleports (≤400px)
- [ ] Brief invincibility after teleporting (verify with debug overlay)
- [ ] Cooldown prevents immediate re-teleport
- [ ] Placing marks works from any movement state without interruption
- [ ] When at 4 marks, placing a 5th replaces the oldest
- [ ] Marks are visually distinct (4 colors)
- [ ] Teleport visual: origin burst, ink trail, destination pop
- [ ] Goal A reachable via mark placement + teleport
- [ ] Multi-mark puzzle (Goal D): all 4 zones activatable within 15 seconds using teleport
- [ ] All index mark params tunable via sliders
- [ ] Debug overlays: mark positions, selection beam, cooldown, goal zones
- [ ] All existing movement mechanics (run, jump, wall, dash) still work
- [ ] Camera follows player across the 3840px level
- [ ] FPS stays at ~60fps
- [ ] Reset buttons work (player, marks, params, goals)

---

## Implementation Summary

### Files Created
- `src/engine/abilities/IndexMark.ts` — Full IndexMark ability system with:
  - `IndexMarkParams` interface with all tunable parameters (maxMarks, holdThreshold, teleportCooldown, teleportVisualDuration, marksExpire, markLifetime, teleportIFrames)
  - `PlacedMark` interface for stored waypoints (position, colorIndex, wasGrounded, remainingLife)
  - `TeleportState` interface tracking selection mode, visual effects, and timers
  - Three-method input API: `onKeyDown()`, `onKeyHeld(input)`, `onKeyUp(playerPos, grounded)`
  - Mark placement with FIFO replacement at max capacity
  - Teleport execution with cooldown, i-frames, and visual effects
  - Full world-space rendering (mark tabs, glow, selection ring, teleport trail)
  - Screen-space HUD rendering (mark inventory, cooldown indicator, distance readouts)
  - ParticleSystem integration for placement, removal, and teleport effects

### Files Modified
- `src/engine/abilities/index.ts` — Added IndexMark exports
- `src/app/test/index-mark/page.tsx` — Full test page replacing stub, with:
  - 3840×1080 test level with 4 distinct areas (Starting Area, Hazard Corridor, Vertical Shaft, Multi-Mark Puzzle)
  - Goal zones (A-D) testing teleport utility, including a timed 4-zone puzzle
  - Camera handling: instant snap for >400px teleports, fast lerp for short distances
  - Debug panel with all IndexMark params as sliders, mark expiry toggle
  - Debug overlays: player state, mark positions, selection beam, cooldown, goal status
  - Full pass criteria tracking (16 criteria with auto-detection)
  - All movement mechanics (run, jump, wall, dash) remain functional
- `src/lib/testStatus.ts` — Updated index-mark status to 'in-progress'
- `AGENTS.md` — Updated Index Mark section from "Upcoming" to documented, updated Phase 2 status, updated Input Actions docs

### Verification
- `npx tsc --noEmit` passes with zero errors
- `npm run build` succeeds — `/test/index-mark` route included in build output
- All existing test pages unaffected

---

## Review Notes (Reviewer: ad3888c6)

### Issues Found & Fixed

1. **Controls legend claimed "D = Toggle debug"** (`page.tsx:989`) — The `d` key is mapped to `InputAction.Right` (movement), not debug toggle. Debug overlays are toggled via a button in the panel, not a keyboard shortcut. Removed the misleading "D = Toggle debug" from the controls legend.

2. **Dead variable `goalZones`** (`page.tsx:405`) — `const goalZones = goalZonesRef.current` was captured in the `handleMount` closure but never used (all loop references correctly use `goalZonesRef.current`). Removed the dead variable.

### Items Verified (No Issues)

- **Fixed-timestep correctness**: `update(dt)` receives dt from the engine's fixed-timestep loop. i-frames decrement by 1 per call (frame-counted, not time-based) — correct since the loop runs at a fixed 60 Hz.
- **State machine integrity**: IndexMark does NOT modify the player state machine. Teleport is a position/velocity override applied in the test page's update callback. All 10 player states remain functional.
- **Input handling**: `isPressed()`, `isHeld()`, `isReleased()` are all properly exposed on InputManager. The three-method input API (`onKeyDown`, `onKeyHeld`, `onKeyUp`) correctly distinguishes tap vs hold.
- **Memory safety**: Engine cleanup in `handleUnmount()` stops the engine and nulls refs. No event listener leaks.
- **TypeScript type safety**: No `any` types. All interfaces properly typed. Discriminated union for `IndexMarkAction` is clean.
- **Slider wiring**: All IndexMark params (maxMarks, holdThreshold, teleportCooldown, teleportVisualDuration, teleportIFrames, markLifetime, marksExpire) are wired to debug sliders and update the engine instance via `im.params[key] = value`.
- **Camera teleport handling**: Long distance (>400px) uses `camera.snapTo()`, short distance uses temporary `followSpeed` override. Both paths correctly implemented.
- **Abilities index.ts**: Exports all types and classes correctly.
- **testStatus.ts**: Index Mark entry added with `in-progress` status.
- **Build verification**: `npx tsc --noEmit` passes, `npm run build` succeeds with `/test/index-mark` route in output.
