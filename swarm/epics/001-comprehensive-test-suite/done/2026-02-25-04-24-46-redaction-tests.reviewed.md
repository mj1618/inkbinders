# Task: Redaction Ability Headless Tests

## What to Build

Create a comprehensive headless test suite for the `Redaction` ability (`src/engine/abilities/Redaction.ts`). This covers cone-based aim targeting, obstacle scanning, activation/deactivation of obstacles, TileMap exclusion zones for solid obstacles, duration/expiry, cooldown, max active redactions, and player ejection on barrier restoration.

**Depends on Task 9 (ability-harness-extensions).** The harness must have `enableRedaction(params?)` available before these tests can run. If the method doesn't exist yet, check `GameTestHarness.ts` — it was added as part of the harness extension work.

## File to Create

`src/engine/test/__tests__/redaction.test.ts`

## Implementation Details

### Setup Pattern

```typescript
import { describe, it, expect, beforeEach } from 'vitest';
import { GameTestHarness } from '../../test/GameTestHarness';
import { DEFAULT_REDACTION_PARAMS } from '../../abilities/Redaction';
import { createSpikes, createBarrier, createLaser, createHazardZone, resetObstacleIdCounter } from '../../../physics/Obstacles';

// Reset obstacle IDs before each test for determinism
beforeEach(() => {
  resetObstacleIdCounter();
});

// Standard test level: floor + a few obstacles at known positions
function createRedactionLevel() {
  const h = new GameTestHarness({
    platforms: [
      // Floor
      { x: 0, y: 300, width: 960, height: 32 },
    ],
  });
  h.setPlayerPosition(100, 260);
  h.tickUntil(() => h.grounded, 60);
  const redaction = h.enableRedaction();
  return { h, redaction };
}
```

### Harness Integration

The `GameTestHarness` already has:
- `enableRedaction(params?)` → returns `Redaction` instance, wired to tileMap
- `addObstacle(obstacle)` → adds to `_obstacles` list AND registers solid obstacles with Redaction's `registerObstaclePlatform()`
- In `tick()`: automatically calls `redaction.scanForTargets(playerCenter, aimDirection, obstacles)` and `redaction.update(dt)` each frame
- The aim direction is computed from `player.facingRight` (facing right → `{x: 1, y: 0}`, facing left → `{x: -1, y: 0}`)
- **Important**: The harness does NOT auto-call `redaction.activate()` — tests must call it manually when testing activation

### Obstacle Setup

Use factory helpers from `src/engine/physics/Obstacles.ts`:
- `createSpikes({ x, y, width, height }, damage?)` — non-solid, deals damage on overlap
- `createBarrier({ x, y, width, height })` — solid, blocks passage (0 damage)
- `createLaser({ x, y, width, height }, damage?)` — non-solid, deals damage
- `createHazardZone({ x, y, width, height }, damage?)` — non-solid, deals damage

Add obstacles via `h.addObstacle(obstacle)`. For barriers, the harness auto-registers the TileMap platform.

### Key Parameters (from DEFAULT_REDACTION_PARAMS)

| Parameter | Default | Notes |
|-----------|---------|-------|
| `maxRedactionRange` | 200 | Max distance from player center to obstacle |
| `redactionDuration` | 5.0 | Seconds before redaction expires |
| `redactionCooldown` | 3.0 | Seconds of cooldown after expiration |
| `maxActiveRedactions` | 2 | Max simultaneous active redactions |
| `aimConeHalfAngle` | π/4 (45°) | Half-angle of targeting cone |
| `enabled` | true | Whether ability is usable |

### Tests to Write

#### Group 1: Target Detection

1. **Scans and finds obstacle in range** — Place spikes 100px to the right of player (within 200px range). Tick once. Verify `redaction.targetedObstacle` is non-null and matches the obstacle.

2. **Out-of-range obstacle not targeted** — Place spikes 300px away (beyond 200px range). Tick. Verify `redaction.targetedObstacle` is null.

3. **Obstacle outside aim cone not targeted** — Place spikes directly above the player (90° from horizontal facing). Tick. Verify `redaction.detectedObstacles` may include it but `redaction.targetedObstacle` is null (since it's outside the ±45° aim cone when facing right horizontally).

4. **Nearest obstacle is targeted** — Place two spikes to the right: one at 80px, one at 150px. Tick. Verify `targetedObstacle` points to the closer one.

5. **Already-redacted obstacle skipped** — Activate redaction on obstacle A. Place obstacle B nearby. Tick. Verify `targetedObstacle` is obstacle B (not A which is already redacted).

#### Group 2: Activation

6. **Successful activation returns true** — Set up an in-range obstacle. Tick. Call `redaction.activate()`. Verify it returns `true`.

7. **Activation sets obstacle.active to false** — After `activate()`, the targeted obstacle's `active` field becomes `false`.

8. **Activation creates exclusion zone for solid obstacle** — Place a barrier (solid obstacle). Activate redaction on it. Verify the player can now move through the barrier's position (the TileMap exclusion zone allows passage).

9. **Non-solid obstacles skip exclusion zone** — Place spikes (non-solid). Activate redaction. The spikes become inactive (no damage) but no TileMap exclusion zone is needed (spikes were never solid).

10. **Cannot activate without target** — With no obstacles in range, `redaction.canActivate` is `false` and `redaction.activate()` returns `false`.

11. **Cannot activate during cooldown** — Activate a redaction, wait for it to expire (5s + a few frames), then check `redaction.cooldownTimer > 0`. During cooldown, `canActivate` is `false`.

12. **Activation count added to activeRedactions** — After activation, `redaction.activeRedactions.length` is 1.

#### Group 3: Duration & Expiration

13. **Redaction lasts for duration** — Activate, then tick for slightly less than `redactionDuration` (e.g., 4.9s). Verify `activeRedactions.length` is still 1.

14. **Redaction expires after duration** — Activate, tick for slightly more than `redactionDuration` (e.g., 5.1s). Verify `activeRedactions.length` is 0.

15. **Obstacle restored on expiration** — After expiration, the obstacle's `active` field becomes `true` again.

16. **Exclusion zone removed on expiration** — After a barrier's redaction expires, the barrier blocks passage again (TileMap collision restored).

17. **Cooldown starts on expiration** — After redaction expires, `redaction.cooldownTimer` is greater than 0 (approximately `redactionCooldown`).

#### Group 4: Cooldown

18. **Cooldown prevents activation** — After expiration, immediately try to activate on a new target. Should fail (`canActivate` is false).

19. **Cooldown expires and allows activation** — After expiration, tick for `redactionCooldown` + margin. Then `canActivate` becomes `true` again (assuming there's a target).

#### Group 5: Max Active Redactions

20. **Can activate up to max** — With `maxActiveRedactions = 2`, activate two redactions on separate obstacles. Both should be in `activeRedactions`.

21. **Cannot exceed max active** — After 2 active redactions, `canActivate` is `false` even with a valid 3rd target in range.

22. **Freeing a slot allows new activation** — After one redaction expires (wait 5s), `activeRedactions.length` drops to 1. Now a new target can be activated.

#### Group 6: Spike/Damage Integration

23. **Redacted spikes don't deal damage** — Place spikes overlapping player position. Before redaction, `checkDamageOverlap()` finds the spike. After redaction, it returns null.

24. **Restored spikes deal damage again** — After redaction expires, spikes are active again and `checkDamageOverlap()` finds them.

#### Group 7: Ejection on Restore (Barrier)

25. **Ejection when player inside restoring barrier** — Place a barrier, redact it, move player into the barrier's space, then let the redaction expire. Call `redaction.getEjectionForObstacle(obstacle, playerPos, playerSize)`. Verify it returns a non-null ejection position that pushes the player out of the barrier.

### Test Utility Notes

- Use `h.tickSeconds(seconds)` for time-based tests (duration, cooldown)
- Use `h.tickN(n)` for frame-precise tests
- Player faces right by default — obstacles to the right are in the aim cone
- To test facing left: press left for a few frames, then release (or set up obstacles to the left)
- Access obstacle fields directly: `obstacle.active`, `obstacle.solid`, etc.
- `checkDamageOverlap()` and `checkObstacleOverlap()` are exported from `Obstacles.ts`

## Verification

Run tests with:
```bash
npx vitest run src/engine/test/__tests__/redaction.test.ts
```

All tests should pass. If `enableRedaction()` is not yet available on the harness, the tests will fail at import/setup — that's expected until Task 9 is fully merged.

## Pass Criteria

- All ~25 test cases pass
- Tests use `DEFAULT_REDACTION_PARAMS` values (not hardcoded magic numbers) for thresholds
- `resetObstacleIdCounter()` called in `beforeEach` for deterministic IDs
- No console errors or warnings during test run
- Tests complete in under 5 seconds total

---

## Completion Summary

### Files Created
- `src/engine/test/__tests__/redaction.test.ts` — 25 test cases across 7 groups

### What Was Built
Comprehensive headless test suite for the Redaction ability covering:

1. **Target Detection (5 tests)**: In-range scanning, out-of-range rejection, aim cone filtering, nearest-target selection, already-redacted obstacle skipping
2. **Activation (7 tests)**: Successful activation, obstacle deactivation, TileMap exclusion zones for solid obstacles, non-solid obstacle handling, no-target guard, cooldown blocking, active count tracking
3. **Duration & Expiration (5 tests)**: Duration persistence, expiration timing, obstacle restoration, exclusion zone cleanup, cooldown trigger on expiry
4. **Cooldown (2 tests)**: Cooldown prevents activation, cooldown expiry allows reactivation
5. **Max Active Redactions (3 tests)**: Activate up to max, max limit enforcement, slot freeing enables new activation
6. **Spike/Damage Integration (2 tests)**: Redacted spikes don't deal damage, restored spikes deal damage again
7. **Ejection on Restore (1 test)**: Player ejection when inside a restoring barrier

### Results
- All 25 tests pass in ~10ms
- `npx tsc --noEmit` passes with zero type errors
- Tests use `DEFAULT_REDACTION_PARAMS` constants throughout (no magic numbers)
- `resetObstacleIdCounter()` called in `beforeEach` for deterministic obstacle IDs
- No new console errors or warnings

---

## Review Notes (reviewer: fdc9718c)

**Verified:**
- All 25 tests pass (12ms total)
- `npx tsc --noEmit` clean — zero type errors
- Test structure follows established project patterns (GameTestHarness, describe groups)
- `DEFAULT_REDACTION_PARAMS` used consistently — no magic numbers
- `resetObstacleIdCounter()` properly in `beforeEach` for determinism
- Aim cone math verified against `Redaction.isInAimCone()` — test 3's geometry is correct
- Duration/cooldown timing uses proper margins (+0.1s, -0.2s) to avoid frame-boundary flakiness
- `checkDamageOverlap` integration tests correctly verify the active flag filtering
- Ejection test covers all four push directions

**Fix applied:**
- Removed unused imports `createLaser` and `createHazardZone` from `@/engine/physics/Obstacles` — they were imported but never used in any test case
