# Task: Challenge Rooms

Create 4 optional timed challenge gauntlets — one per biome mechanic. High difficulty, designed for players who have mastered the controls. Each tests a single biome mechanic in isolation with a time target.

## Overview

Create `src/engine/world/challengeRooms.ts` exporting `CHALLENGE_ROOMS` (Record<string, RoomData>) and `CHALLENGE_ROOM_IDS` (string array).

Also add a `ChallengeTimer` interface to `Room.ts` and a `challengeTimer` optional field to `RoomData`, since challenge rooms need start/end zones and par times.

## Step 1: Add ChallengeTimer to Room.ts

Add the following interface and field to `src/engine/world/Room.ts`:

```typescript
/** Challenge room timer config — defines start/end zones and par time */
export interface ChallengeTimer {
  /** Player overlapping this rect starts the timer */
  startZone: Rect;
  /** Player overlapping this rect stops the timer (challenge complete) */
  endZone: Rect;
  /** Par time in seconds — displayed as the target to beat */
  parTime: number;
}
```

Add to `RoomData` interface (after `cardDrop`):
```typescript
/** Optional challenge timer — makes this room a timed challenge */
challengeTimer?: ChallengeTimer;
```

## Step 2: Create challengeRooms.ts

File: `src/engine/world/challengeRooms.ts`

Import pattern (follow herbariumRooms.ts exactly):
```typescript
import type { RoomData } from "./Room";
import { EXIT_ZONE_DEPTH } from "./Room";

const T = 32;
```

### Room 1: Vine Gauntlet (3840×1080) — Herbarium Wing

**ID**: `vine-gauntlet`
**Name**: "Vine Gauntlet"
**Biome**: `herbarium-folio`
**Parent room**: `herbarium-heart` (add exit later in world-integration task)

This is a pure vine-chaining challenge. 10 vine anchors in an ascending arc pattern over a spike pit. The player must chain all 10 without touching the ground.

**Platforms:**
- Floor (spike base): `{ x: 0, y: 1080 - T, width: 3840, height: T }` — the floor IS the spike pit
- Left wall: `{ x: 0, y: 0, width: T, height: 1080 }`
- Right wall: `{ x: 3840 - T, y: 0, width: T, height: 1080 }`
- Ceiling: `{ x: 0, y: 0, width: 3840, height: T }`
- Start platform (safe zone): `{ x: T, y: 1080 - T - 128, width: 256, height: T }` — left side, above spikes
- End platform (safe zone): `{ x: 3840 - T - 256, y: 1080 - T - 128, width: 256, height: T }` — right side, above spikes

**Obstacles:**
- Full-width spike pit: `{ id: "vg_spikes", rect: { x: T + 256, y: 1080 - T - T, width: 3840 - T*2 - 512, height: T }, type: "spikes", damage: 1, solid: false }`
  (Starts after start platform, ends before end platform)

**Vine anchors** (10 vines in ascending arc pattern):
```
id: "vg_vine_1",  position: { x: 500, y: 200 },  ropeLength: 200, type: "ceiling"
id: "vg_vine_2",  position: { x: 820, y: 160 },  ropeLength: 220, type: "hanging"
id: "vg_vine_3",  position: { x: 1140, y: 130 },  ropeLength: 240, type: "ceiling"
id: "vg_vine_4",  position: { x: 1460, y: 110 },  ropeLength: 250, type: "hanging"
id: "vg_vine_5",  position: { x: 1780, y: 100 },  ropeLength: 260, type: "ceiling"  // apex
id: "vg_vine_6",  position: { x: 2100, y: 100 },  ropeLength: 260, type: "hanging"  // apex
id: "vg_vine_7",  position: { x: 2420, y: 110 },  ropeLength: 250, type: "ceiling"
id: "vg_vine_8",  position: { x: 2740, y: 130 },  ropeLength: 240, type: "hanging"
id: "vg_vine_9",  position: { x: 3060, y: 160 },  ropeLength: 220, type: "ceiling"
id: "vg_vine_10", position: { x: 3380, y: 200 },  ropeLength: 200, type: "hanging"
```

The vine spacing (~320px) is just close enough to chain from one to the next with good momentum but requires proper swing timing. Rope lengths create an arc shape — longer ropes in the middle, shorter at edges.

**Default spawn**: `{ x: 128, y: 1080 - T - 128 - 64 }` (on start platform)

**Exits:**
- Left exit → `herbarium-heart`: `{ direction: "left", zone: { x: 0, y: 1080 - T - 128, width: EXIT_ZONE_DEPTH, height: 64 }, targetRoomId: "herbarium-heart", targetSpawnPoint: { x: 1380, y: 1080 - 64 - T } }`

**Challenge timer:**
- Start zone: `{ x: T + 160, y: 1080 - T - 128 - 96, width: 96, height: 96 }` (right edge of start platform, where player starts moving toward vines)
- End zone: `{ x: 3840 - T - 256, y: 1080 - T - 128 - 96, width: 96, height: 96 }` (left edge of end platform)
- Par time: `30`

**Card drop**: `{ definitionId: "dash-inscription", tier: 2, position: { x: 3840 - T - 160, y: 1080 - T - 128 - 32 } }` (on end platform)

**No enemies** — pure traversal.

---

### Room 2: Gravity Maze (1920×1920) — Astral Atlas Wing

**ID**: `gravity-maze`
**Name**: "Gravity Maze"
**Biome**: `astral-atlas`
**Parent room**: `orrery-chamber`

A square room with a maze of gravity wells forming "tunnels" upward. Attract wells create corridors the player floats through. Repel wells are hazards that push into spike walls.

**Platforms:**
- Floor: `{ x: 0, y: 1920 - T, width: 1920, height: T }`
- Ceiling: `{ x: 0, y: 0, width: 1920, height: T }`
- Left wall: `{ x: 0, y: 0, width: T, height: 1920 }`
- Right wall: `{ x: 1920 - T, y: 0, width: T, height: 1920 }`
- Start platform (bottom-left): `{ x: T, y: 1920 - T - 96, width: 256, height: T }`
- End platform (top-center): `{ x: 800, y: T + 64, width: 320, height: T }`
- Intermediate rest platforms (small, 3 of them — mid-checkpoints):
  - `{ x: 300, y: 1400, width: 128, height: T }` — bottom-right landing
  - `{ x: 1500, y: 1000, width: 128, height: T }` — mid-right landing
  - `{ x: 500, y: 600, width: 128, height: T }` — upper-left landing

**Obstacles:**
- Spike strips along walls (push-into hazards from repel wells):
  - `{ id: "gm_spikes_left", rect: { x: T, y: 400, width: T, height: 600 }, type: "spikes", damage: 1, solid: false }`
  - `{ id: "gm_spikes_right", rect: { x: 1920 - T - T, y: 600, width: T, height: 600 }, type: "spikes", damage: 1, solid: false }`
  - `{ id: "gm_spikes_ceil", rect: { x: 400, y: T, width: 400, height: T }, type: "spikes", damage: 1, solid: false }`
  - `{ id: "gm_spikes_ceil2", rect: { x: 1120, y: T, width: 400, height: T }, type: "spikes", damage: 1, solid: false }`

**Gravity wells** (maze pattern — attract wells form corridors, repel wells are hazards):
```
// Corridor 1: Bottom-left → bottom-right (attract tunnel)
id: "gm_attract_1", position: { x: 500, y: 1700 },  radius: 250, strength: 180, type: "attract"
id: "gm_attract_2", position: { x: 900, y: 1650 },  radius: 250, strength: 180, type: "attract"
// Hazard: repel well blocking direct path up from start
id: "gm_repel_1",   position: { x: 700, y: 1300 },  radius: 200, strength: 250, type: "repel"
// Corridor 2: Bottom-right → mid-right (vertical attract tunnel)
id: "gm_attract_3", position: { x: 1500, y: 1300 }, radius: 250, strength: 200, type: "attract"
id: "gm_attract_4", position: { x: 1450, y: 1000 }, radius: 250, strength: 200, type: "attract"
// Hazard: repel well between corridors
id: "gm_repel_2",   position: { x: 1100, y: 1100 }, radius: 220, strength: 280, type: "repel"
// Corridor 3: Mid-right → upper-left (diagonal attract tunnel)
id: "gm_attract_5", position: { x: 1200, y: 800 },  radius: 250, strength: 180, type: "attract"
id: "gm_attract_6", position: { x: 800, y: 600 },   radius: 250, strength: 180, type: "attract"
// Hazard: repel well near center
id: "gm_repel_3",   position: { x: 960, y: 900 },   radius: 180, strength: 300, type: "repel"
// Corridor 4: Upper-left → top-center (final approach)
id: "gm_attract_7", position: { x: 600, y: 400 },   radius: 250, strength: 200, type: "attract"
id: "gm_attract_8", position: { x: 900, y: 200 },   radius: 250, strength: 200, type: "attract"
// Hazard: repel wells flanking the final corridor
id: "gm_repel_4",   position: { x: 300, y: 300 },   radius: 180, strength: 250, type: "repel"
id: "gm_repel_5",   position: { x: 1500, y: 400 },  radius: 200, strength: 250, type: "repel"
```

This creates a snake-like path: start bottom-left → float right along bottom → float up on right side → float diagonally to upper-left → float to top-center goal. Repel wells block shortcuts and punish wrong turns by pushing into spike walls.

**Default spawn**: `{ x: 128, y: 1920 - T - 96 - 64 }` (on start platform)

**Exits:**
- Bottom exit → `orrery-chamber`: `{ direction: "bottom", zone: { x: T, y: 1920 - EXIT_ZONE_DEPTH, width: 256, height: EXIT_ZONE_DEPTH }, targetRoomId: "orrery-chamber", targetSpawnPoint: { x: 720, y: 1080 - 64 - T } }`

**Challenge timer:**
- Start zone: `{ x: T + 180, y: 1920 - T - 96 - 64, width: 76, height: 64 }` (right side of start platform)
- End zone: `{ x: 880, y: T + 64, width: 160, height: 64 }` (on end platform at top)
- Par time: `45`

**Card drop**: `{ definitionId: "scribes-haste", tier: 2, position: { x: 960, y: T + 32 } }` (on end platform)

**No enemies** — pure gravity navigation.

---

### Room 3: Current Sprint (3840×540) — Maritime Ledger Wing

**ID**: `current-sprint`
**Name**: "Current Sprint"
**Biome**: `maritime-ledger`
**Parent room**: `whirlpool-depths`

A long horizontal room. The player rides alternating jet streams and navigates whirlpools at high speed. Gust zones pulse on/off — timing is critical.

**Platforms:**
- Floor: `{ x: 0, y: 540 - T, width: 3840, height: T }`
- Ceiling: `{ x: 0, y: 0, width: 3840, height: T }`
- Left wall: `{ x: 0, y: 0, width: T, height: 540 }`
- Right wall: `{ x: 3840 - T, y: 0, width: T, height: 540 }`
- Start platform (elevated): `{ x: T, y: 540 - T - 96, width: 192, height: T }`
- End platform (elevated): `{ x: 3840 - T - 192, y: 540 - T - 96, width: 192, height: T }`
- Island platforms (gaps in floor where whirlpools sit):
  - `{ x: 960, y: 300, width: 128, height: T }` — above whirlpool 1
  - `{ x: 1920, y: 280, width: 128, height: T }` — above whirlpool 2
  - `{ x: 2880, y: 300, width: 128, height: T }` — above whirlpool 3

**Obstacles:**
- Spike rows at floor level between platforms (falling into the current is dangerous):
  - `{ id: "cs_spikes_1", rect: { x: 600, y: 540 - T - T, width: 200, height: T }, type: "spikes", damage: 1, solid: false }`
  - `{ id: "cs_spikes_2", rect: { x: 1500, y: 540 - T - T, width: 200, height: T }, type: "spikes", damage: 1, solid: false }`
  - `{ id: "cs_spikes_3", rect: { x: 2400, y: 540 - T - T, width: 200, height: T }, type: "spikes", damage: 1, solid: false }`
  - `{ id: "cs_spikes_4", rect: { x: 3200, y: 540 - T - T, width: 200, height: T }, type: "spikes", damage: 1, solid: false }`

**Current zones:**
```
// Jet 1: Initial boost (rightward)
id: "cs_jet_1", rect: { x: 200, y: 100, width: 200, height: 300 }, direction: { x: 1, y: 0 }, strength: 900, type: "jet"

// Whirlpool 1: First obstacle (clockwise)
id: "cs_whirlpool_1", rect: { x: 800, y: 100, width: 400, height: 400 }, direction: { x: 0, y: 0 }, strength: 400, type: "whirlpool", clockwise: true

// Gust 1: Pulsing updraft (ride over whirlpool)
id: "cs_gust_1", rect: { x: 1200, y: 200, width: 200, height: 200 }, direction: { x: 0, y: -1 }, strength: 600, type: "gust", gustOnDuration: 2.0, gustOffDuration: 1.5, gustOffset: 0

// Jet 2: Mid-section speed boost
id: "cs_jet_2", rect: { x: 1400, y: 80, width: 300, height: 200 }, direction: { x: 1, y: 0 }, strength: 1000, type: "jet"

// Whirlpool 2: Second obstacle (counter-clockwise)
id: "cs_whirlpool_2", rect: { x: 1750, y: 50, width: 450, height: 450 }, direction: { x: 0, y: 0 }, strength: 450, type: "whirlpool", clockwise: false

// Gust 2: Pulsing downdraft (must time through)
id: "cs_gust_2", rect: { x: 2200, y: 150, width: 200, height: 250 }, direction: { x: 0, y: 1 }, strength: 500, type: "gust", gustOnDuration: 1.5, gustOffDuration: 2.0, gustOffset: 0.5

// Jet 3: Recovery boost
id: "cs_jet_3", rect: { x: 2500, y: 100, width: 200, height: 250 }, direction: { x: 1, y: -0.3 }, strength: 800, type: "jet"

// Whirlpool 3: Final obstacle (clockwise, strongest)
id: "cs_whirlpool_3", rect: { x: 2750, y: 50, width: 400, height: 400 }, direction: { x: 0, y: 0 }, strength: 500, type: "whirlpool", clockwise: true

// Stream: Final tailwind to finish line
id: "cs_stream_1", rect: { x: 3200, y: 50, width: 400, height: 400 }, direction: { x: 1, y: 0 }, strength: 300, type: "stream"
```

The flow: Jet launch → dodge whirlpool 1 → ride timed gust → jet boost → dodge whirlpool 2 → time through downdraft → recovery jet → fight through final whirlpool → ride tailwind to finish.

**Default spawn**: `{ x: 96, y: 540 - T - 96 - 64 }` (on start platform)

**Exits:**
- Left exit → `whirlpool-depths`: `{ direction: "left", zone: { x: 0, y: 540 - T - 96, width: EXIT_ZONE_DEPTH, height: 64 }, targetRoomId: "whirlpool-depths", targetSpawnPoint: { x: 1380, y: 1080 - 64 - T } }`

**Challenge timer:**
- Start zone: `{ x: T + 128, y: 540 - T - 96 - 64, width: 64, height: 64 }` (right edge of start platform)
- End zone: `{ x: 3840 - T - 192, y: 540 - T - 96 - 64, width: 64, height: 64 }` (on end platform)
- Par time: `25`

**Card drop**: `{ definitionId: "snap-verse", tier: 2, position: { x: 3840 - T - 128, y: 540 - T - 96 - 32 } }` (on end platform)

**No enemies** — pure current navigation.

---

### Room 4: Fog Labyrinth (1920×1080) — Gothic Errata Wing

**ID**: `fog-labyrinth`
**Name**: "Fog Labyrinth"
**Biome**: `gothic-errata`
**Parent room**: `scriptorium-ruin`

Dense fog everywhere with a tiny visibility radius. An inversion zone and a scramble zone create navigation confusion. Dead ends with spike traps. Must use dash to temporarily clear fog and memorize the path.

**Platforms:**
- Floor: `{ x: 0, y: 1080 - T, width: 1920, height: T }`
- Ceiling: `{ x: 0, y: 0, width: 1920, height: T }`
- Left wall: `{ x: 0, y: 0, width: T, height: 1080 }`
- Right wall: `{ x: 1920 - T, y: 0, width: T, height: 1080 }`
- Start platform (bottom-left, safe): `{ x: T, y: 1080 - T - 96, width: 192, height: T }`
- End platform (top-right, safe): `{ x: 1920 - T - 192, y: T + 64, width: 192, height: T }`

**Maze walls** (internal barriers creating a winding path):
```
// Row 1 (bottom): horizontal wall segments forcing zigzag
{ x: 300, y: 900, width: 400, height: T }
{ x: 900, y: 900, width: T, height: 180 }  // vertical divider
{ x: 1200, y: 850, width: 400, height: T }

// Row 2: middle maze section
{ x: T, y: 700, width: 350, height: T }     // blocks left shortcut
{ x: 600, y: 680, width: 500, height: T }
{ x: 1400, y: 700, width: 200, height: T }
{ x: 1600, y: 600, width: T, height: 200 }  // vertical divider

// Row 3: upper section
{ x: 300, y: 500, width: 200, height: T }
{ x: 700, y: 480, width: 400, height: T }
{ x: 1300, y: 450, width: 300, height: T }

// Row 4: near-top
{ x: T, y: 320, width: 500, height: T }     // blocks left
{ x: 800, y: 300, width: 400, height: T }
{ x: 1400, y: 280, width: 200, height: T }

// Row 5: top approach
{ x: 400, y: 160, width: 600, height: T }   // forces right detour to reach end
```

**Dead-end traps** (spikes at tempting dead ends):
```
{ id: "fl_spikes_1", rect: { x: 1200, y: 900 - T, width: 128, height: T }, type: "spikes", damage: 1, solid: false }  // dead end right of row 1
{ id: "fl_spikes_2", rect: { x: T, y: 680 - T, width: 128, height: T }, type: "spikes", damage: 1, solid: false }     // dead end left of row 2
{ id: "fl_spikes_3", rect: { x: 1600, y: 600 - T, width: 128, height: T }, type: "spikes", damage: 1, solid: false }  // dead end right of row 2
{ id: "fl_spikes_4", rect: { x: 300, y: 480 - T, width: 128, height: T }, type: "spikes", damage: 1, solid: false }   // dead end left of row 3
{ id: "fl_spikes_5", rect: { x: T, y: 300 - T, width: 128, height: T }, type: "spikes", damage: 1, solid: false }     // dead end left of row 4
```

**Fog zones:**
```
// Dense fog covering almost the entire room (extremely limited visibility)
id: "fl_fog_1", rect: { x: 0, y: 0, width: 1920, height: 1080 }, type: "fog", density: 0.95

// Inversion zone in the middle section (controls swap left/right)
id: "fl_inversion_1", rect: { x: 500, y: 550, width: 600, height: 250 }, type: "inversion", density: 0

// Scramble zone in the upper section (all directions shuffled)
id: "fl_scramble_1", rect: { x: 700, y: 200, width: 500, height: 200 }, type: "scramble", density: 0
```

**Default spawn**: `{ x: 96, y: 1080 - T - 96 - 64 }` (on start platform)

**Exits:**
- Bottom-left exit → `scriptorium-ruin`: `{ direction: "left", zone: { x: 0, y: 1080 - T - 96, width: EXIT_ZONE_DEPTH, height: 64 }, targetRoomId: "scriptorium-ruin", targetSpawnPoint: { x: 1380, y: 1080 - 64 - T } }`

**Challenge timer:**
- Start zone: `{ x: T + 128, y: 1080 - T - 96 - 64, width: 64, height: 64 }` (right side of start platform)
- End zone: `{ x: 1920 - T - 192, y: T + 64, width: 128, height: 64 }` (on end platform at top-right)
- Par time: `60`

**Card drop**: `{ definitionId: "stoic-page", tier: 2, position: { x: 1920 - T - 128, y: T + 32 } }` (on end platform)

**Health pickup**: `{ id: "fl_hp_1", position: { x: 1450, y: 430 }, healAmount: 1 }` (hidden in upper maze section — reward for exploration)

**No enemies** — pure fog navigation.

---

## Step 3: Add Exits from Parent Rooms

**IMPORTANT**: Do NOT add these exits yet. This task creates the room definitions only. Task 4 (world-integration) will wire exits from parent rooms to challenge rooms. However, design the exit/spawn points with this in mind:

- `herbarium-heart` → `vine-gauntlet`: Will need a new bottom exit in herbarium-heart (challenge rooms are optional — not on the main path)
- `orrery-chamber` → `gravity-maze`: Will need a new top exit in orrery-chamber
- `whirlpool-depths` → `current-sprint`: Will need a new bottom exit in whirlpool-depths
- `scriptorium-ruin` → `fog-labyrinth`: Will need a new right exit in scriptorium-ruin (a second right exit, placed above the existing one)

The return exits in the challenge rooms ARE defined in this task (they point back to the parent room). The parent-to-challenge exits will be added during world-integration.

## Verification

1. Create `src/engine/world/challengeRooms.ts` with all 4 room definitions
2. Add `ChallengeTimer` interface and `challengeTimer` field to `Room.ts`
3. Export pattern: `CHALLENGE_ROOMS` (Record<string, RoomData>) and `CHALLENGE_ROOM_IDS` (string array)
4. Run `npx tsc --noEmit` — must compile cleanly
5. Each room has:
   - Correct biome ID matching its wing
   - Exactly 1 return exit pointing to the parent room
   - A `challengeTimer` with `startZone`, `endZone`, and `parTime`
   - A tier-2 `cardDrop` of the appropriate category
   - Platform layout that creates a clear start→finish path using the biome mechanic
   - No enemies (pure traversal/mechanic mastery)
   - Obstacles (spikes) as hazards/punishment

## Notes

- Follow the exact export pattern from `herbariumRooms.ts` (Record + array)
- Do NOT modify `demoWorld.ts`, `index.ts`, or any parent room files — that's the integration task
- Do NOT modify the play page — challenge timer handling is also in the integration task
- The `ChallengeTimer` data is declarative only — the play page will need to read it and implement the timer logic (in the integration task)
- Vine anchors use the same `RoomVineAnchor` interface — spacing matters for chainability
- Gravity wells, current zones, and fog zones use existing RoomData fields
- Card definition IDs used: `dash-inscription` (Swiftness), `scribes-haste` (Arcana), `snap-verse` (Might), `stoic-page` (Resilience)

---

## Completion Summary

### Files Changed
1. **`src/engine/world/Room.ts`** — Added `ChallengeTimer` interface and `challengeTimer` optional field to `RoomData`
2. **`src/engine/world/challengeRooms.ts`** — Created new file with 4 challenge room definitions

### What Was Built
- **ChallengeTimer** interface: `startZone` (Rect), `endZone` (Rect), `parTime` (number)
- **Vine Gauntlet** (3840×1080, herbarium-folio): 10 vine anchors in ascending arc over spike pit, par time 30s, tier-2 `dash-inscription`
- **Gravity Maze** (1920×1920, astral-atlas): 8 attract wells forming corridors + 5 repel well hazards, par time 45s, tier-2 `scribes-haste`
- **Current Sprint** (3840×540, maritime-ledger): Jets, whirlpools, gusts, and streams in sequence, par time 25s, tier-2 `snap-verse`
- **Fog Labyrinth** (1920×1080, gothic-errata): Dense fog maze with inversion/scramble zones and dead-end spike traps, par time 60s, tier-2 `stoic-page`

### Verification
- `npx tsc --noEmit` compiles cleanly (only pre-existing test-page errors remain)
- Each room has correct biome, 1 return exit, challengeTimer, tier-2 cardDrop, no enemies
- Export pattern matches herbariumRooms.ts: `CHALLENGE_ROOMS` (Record) + `CHALLENGE_ROOM_IDS` (const array)

---

## Review Notes

**Reviewer:** e3a866b3
**Date:** 2026-02-25

### Fix Applied
- **Room.ts: Moved `ChallengeTimer` interface definition before `RoomData`** — The interface was defined after its usage in `RoomData`. While TypeScript hoists interfaces so this compiled, it's better practice to define types before using them. Moved the definition above `RoomData` for consistency with all other interfaces in the file.

### Verified (No Issues)
- All 4 challenge rooms match spec exactly — correct biomes, return exits, challenge timers, card drops, no enemies
- Room geometry is sound — platform positions, spike placements, vine spacing, gravity well corridors all make sense
- TypeScript compiles cleanly (`npx tsc --noEmit`)
- All 427 tests pass
- Export pattern (`CHALLENGE_ROOMS` Record + `CHALLENGE_ROOM_IDS` const array) follows existing conventions
- Current zone types (jet/whirlpool/gust/stream) all use correct `CurrentZoneDef` interface fields
- Gravity well types (attract/repel) match `GravityWellDef` interface
- Fog zone types (fog/inversion/scramble) match `FogZoneDef` interface
- Vine anchor types (ceiling/hanging) match `RoomVineAnchor` interface
