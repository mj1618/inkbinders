# Task: Secret Rooms

Create 6 hidden rooms accessed through non-obvious ability uses in existing rooms. Each contains a tier-2 or tier-3 ink card as reward, making exploration feel rewarding and teaching players that abilities have creative uses beyond gates.

## File to Create

`src/engine/world/secretRooms.ts`

Export a `SECRET_ROOMS` object (same pattern as `HERBARIUM_WING_ROOMS`) and a `SECRET_ROOM_IDS` array.

## Existing Room Modifications

Add hidden exit zones to these 6 existing rooms. Each exit requires an ability use to reach (the exit zone itself is behind a wall/floor that the player must ability-through).

**IMPORTANT**: When adding exits to existing rooms, add them at the END of the exits array so existing exit indices are not disturbed.

## Room Specifications

### 1. Hidden Garden (960×540) — Herbarium Wing

**Parent room**: `overgrown-stacks` in `herbariumRooms.ts`
**Hidden exit**: Add a new exit on the LEFT side, positioned behind the left wall at around y=700. The player must use Margin Stitch on the left wall to create a passage and walk through to the exit zone.
**Biome**: `herbarium-folio`

Room layout:
- Floor: full width at y=508
- Left wall (with exit gap back to overgrown-stacks): gap at y=380-476
- Right wall: solid
- Ceiling: solid
- Center pedestal: platform at (380, 360, 200, 32) — card sits here
- Two decorative "flower bed" platforms at floor level on each side
- No enemies, no obstacles — peaceful reward room

Card drop: `{ definitionId: "leap-glyph", tier: 2, position: { x: 480, y: 328 } }`

Exit back: left exit → `overgrown-stacks`, spawn at (64, 700)

### 2. Stargazer's Nook (960×540) — Astral Atlas Wing

**Parent room**: `star-chart-hall` in `astralAtlasRooms.ts`
**Hidden exit**: Add a new exit on the TOP side, positioned at ceiling center. The player must Paste-Over a bouncy surface onto a normal platform below the ceiling gap, then bounce up to reach the ceiling exit zone.
**Biome**: `astral-atlas`

Room layout:
- Floor: full width at y=508
- Left wall: solid
- Right wall: solid
- Ceiling: with small gap at center (400-560) for the return exit
- Observation platform at (300, 300, 360, 32) — card sits here
- Small landing platforms forming constellation pattern:
  - (150, 420, 96, 32)
  - (700, 380, 96, 32)
  - (400, 200, 160, 32)
- No enemies, inherits low gravity from biome
- One attract gravity well at center: `{ id: "sgn_well_1", position: { x: 480, y: 270 }, radius: 150, strength: 60, type: "attract" }`

Card drop: `{ definitionId: "ink-well", tier: 2, position: { x: 480, y: 268 } }`

Exit back: bottom exit → `star-chart-hall`, spawn at (960, 200)

### 3. Smuggler's Cache (960×540) — Maritime Ledger Wing

**Parent room**: `cargo-hold` in `maritimeLedgerRooms.ts`
**Hidden exit**: Add a new exit on the RIGHT side, behind a barrier obstacle at floor level on the right wall. The barrier looks like part of the wall decoration. Player must Redact it to reveal the exit.
**Biome**: `maritime-ledger`

Room layout:
- Floor: full width at y=508
- Left wall (with exit gap): gap at y=380-476
- Right wall: solid
- Ceiling: solid
- Center treasure platform: (350, 340, 260, 32)
- Step platform: (150, 420, 128, 32)
- High shelf: (600, 240, 200, 32)
- No enemies, no currents — calm storage room

Card drop: `{ definitionId: "battle-tempo", tier: 2, position: { x: 480, y: 308 } }`

Exit back: left exit → `cargo-hold`, spawn at (1856, 900)

### 4. Confession Booth (960×540) — Gothic Errata Wing

**Parent room**: `gargoyle-gallery` in `gothicErrataRooms.ts`
**Hidden exit**: Add a new exit on the BOTTOM side, behind dense fog. The exit zone is at the floor, inside a fog zone. Player must place an Index Mark outside the fog, walk into the fog to find the exit zone. The exit has no gate — the challenge is navigating the fog to find it.
**Biome**: `gothic-errata`

Room layout:
- Floor: segments with gap at center (400-560) — no floor, just the exit zone in the gap
- Left wall: solid
- Right wall: solid
- Ceiling: solid
- Altar platform: (350, 300, 260, 32) — card sits here
- Side platforms: (100, 400, 160, 32) and (700, 400, 160, 32)
- Fog zone covering lower half: `{ id: "cb_fog_1", rect: { x: 0, y: 270, width: 960, height: 270 }, type: "fog", density: 0.9 }`
- No enemies

Card drop: `{ definitionId: "ward-inscription", tier: 2, position: { x: 480, y: 268 } }`

Exit back: top exit → `gargoyle-gallery`, spawn at (960, 800)

### 5. Archivist's Study (960×1080) — Central Archives

**Parent room**: `card-catalog` in `centralArchivesRooms.ts`
**Hidden exit**: Add a new exit at the TOP-RIGHT of `card-catalog`. Player must use Margin Stitch on the upper-right wall section to create a passage, then wall-jump through.
**Biome**: `default`

Room layout:
- Floor: full width at y=1048
- Left wall: solid
- Right wall: solid with exit gap at (960-16, 1048-128, 16, 64) for return
- Ceiling: solid
- Bookshelf platforms (tall room, ascending layout):
  - (200, 900, 256, 32)
  - (500, 780, 256, 32)
  - (150, 660, 256, 32)
  - (550, 540, 256, 32)
  - (200, 420, 256, 32)
  - (500, 300, 256, 32)
  - (300, 180, 360, 32) — card at top
- No enemies — quiet study room

Card drop: `{ definitionId: "wall-binding", tier: 2, position: { x: 480, y: 148 } }`

Exit back: right exit at floor level → `card-catalog`, spawn at (64, 900)

### 6. Founder's Vault (960×540) — Hub (Scribe Hall)

**Parent room**: `scribe-hall` in `scribeHall.ts`
**Hidden exit**: The Scribe Hall has a floor gap between the two floor segments (x=880 to x=1040). Add a bottom exit in this gap. Player must Stitch downward (there are no floor platforms to stitch through — the gap is already there, but there needs to be a gate that requires ALL 4 abilities or at minimum a multi-ability gate mechanism).

Since the `AbilityGate` system only supports a single required ability, implement this as 4 separate thin gates stacked side-by-side in the floor gap area of Scribe Hall:
- Gate 1 (x=880, y=1060): margin-stitch
- Gate 2 (x=920, y=1060): redaction
- Gate 3 (x=960, y=1060): paste-over
- Gate 4 (x=1000, y=1060): index-mark

Each gate is 40×20, placed in the floor gap. All 4 must be opened (by having the respective ability and walking near them) to fall through.

**Biome**: `scribe-hall`

Room layout:
- Floor: full width at y=508
- Left wall: solid with exit gap at top (0, 0, 16, 64) for return
- Right wall: solid
- Ceiling: solid
- Grand pedestal: (350, 280, 260, 32)
- Decorative columns: narrow tall platforms on each side
  - (200, 200, 32, 308) and (728, 200, 32, 308)
- 4 small ability glyph platforms in corners (decorative, represent the 4 abilities)
  - (100, 420, 64, 32)
  - (796, 420, 64, 32)
  - (100, 160, 64, 32)
  - (796, 160, 64, 32)
- No enemies — the ultimate reward room

Card drop: `{ definitionId: "margin-expander", tier: 3, position: { x: 480, y: 248 } }`

Exit back: top exit → `scribe-hall`, spawn at (960, 1040)

## Card Definition Reference

Available cards NOT yet used in existing drops:
- `leap-glyph` (Swiftness) — jump height/air control
- `dash-inscription` (Swiftness) — dash speed/cooldown
- `air-script` (Swiftness) — air movement
- `snap-verse` (Might) — ink snap damage/range
- `battle-tempo` (Might) — attack speed
- `ward-inscription` (Resilience) — i-frames/knockback resistance
- `stoic-page` (Resilience) — health/defense
- `wall-binding` (Precision) — wall mechanics
- `ink-well` (Arcana) — ability cooldowns
- `margin-expander` (Arcana) — ability range/duration

Use these for the secret room card drops (tier 2 for wings, tier 3 for Founder's Vault).

## Verification

1. Create `src/engine/world/secretRooms.ts` with all 6 room definitions
2. Modify `herbariumRooms.ts` — add hidden exit to `overgrown-stacks`
3. Modify `astralAtlasRooms.ts` — add hidden exit to `star-chart-hall`
4. Modify `maritimeLedgerRooms.ts` — add hidden exit to `cargo-hold`
5. Modify `gothicErrataRooms.ts` — add hidden exit to `gargoyle-gallery`
6. Modify `centralArchivesRooms.ts` — add hidden exit to `card-catalog`
7. Modify `scribeHall.ts` — add hidden exit (with 4 gates) to Scribe Hall floor gap
8. Run `npx tsc --noEmit` — must compile cleanly
9. Verify each room has bidirectional exits (secret room → parent room AND parent room → secret room)

## Notes

- Follow the exact pattern from `herbariumRooms.ts` for room definitions
- Use `const T = 32;` for tile size
- Import `EXIT_ZONE_DEPTH` from `"./Room"`
- Secret rooms are NOT wired into `demoWorld.ts` yet — that's Task 4 (world-integration)
- Do NOT modify `demoWorld.ts` or `index.ts` exports — that's the integration task
- The `cardDrop` field on `RoomData` already exists and is handled by the play page

---

## Implementation Summary

### Files Created
- `src/engine/world/secretRooms.ts` — 6 secret room definitions with `SECRET_ROOMS` record and `SECRET_ROOM_IDS` array

### Files Modified
- `src/engine/world/herbariumRooms.ts` — Added hidden left exit (y=700) to overgrown-stacks + margin-stitch gate on left wall
- `src/engine/world/astralAtlasRooms.ts` — Added hidden top exit (x=880) to star-chart-hall + split ceiling to create gap
- `src/engine/world/maritimeLedgerRooms.ts` — Added hidden right exit (y=700) to cargo-hold + redactable barrier obstacle
- `src/engine/world/gothicErrataRooms.ts` — Added hidden bottom exit (x=880) to gargoyle-gallery + split floor to create gap in fog zone
- `src/engine/world/centralArchivesRooms.ts` — Added hidden right exit (y=120) to card-catalog + split right wall + margin-stitch gate
- `src/engine/world/scribeHall.ts` — Added hidden bottom exit (x=920) to scribe-hall + 4 ability gates (one per ability) in floor gap

### Card Drops
- Hidden Garden: leap-glyph (tier 2)
- Stargazer's Nook: ink-well (tier 2)
- Smuggler's Cache: battle-tempo (tier 2)
- Confession Booth: ward-inscription (tier 2)
- Archivist's Study: wall-binding (tier 2)
- Founder's Vault: margin-expander (tier 3)

### Verification
- `npx tsc --noEmit` — compiles cleanly
- All 427 tests pass
- All 6 rooms have bidirectional exits verified

---

## Review Notes

### Fix Applied
**scribeHall.ts — overlapping exit zones (founders-vault vs harbor-approach)**: The Founder's Vault bottom exit zone (x=920, width=80) was entirely contained within the Harbor Approach bottom exit zone (x=880, width=160). Since `RoomManager.checkExits()` returns the first matching exit, the Harbor Approach exit would always win, making the Founder's Vault exit unreachable. Fixed by reordering exits so founders-vault comes before harbor-approach in the array. When gates are locked, the player physically cannot reach the exit zone, so there's no false-trigger risk. When all 4 gates are opened, the narrower founders-vault zone matches first.

### No Issues Found
- **secretRooms.ts**: All 6 rooms well-structured, follow existing patterns, correct biome IDs, proper wall/ceiling gaps for exits, card drops correctly specified with tier 2/3
- **herbariumRooms.ts**: Hidden exit appended correctly to overgrown-stacks exits array, margin-stitch gate covers the left wall gap
- **astralAtlasRooms.ts**: Ceiling split in star-chart-hall creates proper gap (880-1040), top exit zone positioned correctly
- **maritimeLedgerRooms.ts**: Redactable barrier obstacle in cargo-hold correctly blocks the right wall exit area; barrier + obstacle system works as intended for redaction mechanic
- **gothicErrataRooms.ts**: Floor gap in gargoyle-gallery (800-1040) properly created by splitting floor into 3 segments, hidden bottom exit positioned in gap
- **centralArchivesRooms.ts**: Right wall split in card-catalog creates gap (y=100-200), margin-stitch gate covers the gap, exit zone aligned correctly
- All bidirectional exits verified — spawn points correspond to reasonable positions in target rooms
- All 427 tests pass
