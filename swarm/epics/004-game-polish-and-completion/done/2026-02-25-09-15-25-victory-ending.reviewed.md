# Victory Ending — Victory Screen When All Bosses Defeated

## Goal

When all 3 main bosses (Footnote Giant, Misprint Seraph, Index Eater) are defeated and the player returns to the Scribe Hall hub, trigger an ending sequence with a typewriter text reveal, player stats display, and return to the title screen.

## What Already Exists

- Boss defeats tracked in `GameSession.defeatedBosses` (a `Set<string>`)
- Boss defeat detection in play page update loop (lines ~1268-1277): checks `d.isAlive` on dummies, calls `session.defeatBoss(bossId)`
- The 3 main boss IDs: `"footnote-giant"`, `"misprint-seraph"`, `"index-eater"`
- Hub detection: `roomManager.currentRoom.id === "scribe-hall"` (used in play page)
- Pause menu overlay pattern: dark background → centered box → text rendering → selection navigation
- Session state exposes: `totalPlayTime`, `deathCount`, `defeatedBosses`, `completionPercent`, `playerName`, `visitedRooms`, `unlockedAbilities`
- `router.push("/")` for navigation back to title
- Screen-space render via `engine.getRenderer().addLayerCallback("debug", screenLayerCallback)`
- `SaveSystem.formatPlayTime(seconds)` for time formatting

## Implementation Steps

### 1. Create `VictoryScreen` engine class

**File: `src/engine/ui/VictoryScreen.ts`** (new file)

This is a pure engine class (no React). It manages the typewriter text sequence, stats display, and input detection.

```typescript
export interface VictoryStats {
  playerName: string;
  playTimeSeconds: number;
  deaths: number;
  roomsVisited: number;
  totalRooms: number;
  abilitiesUnlocked: number;
  cardsCollected: number;
  completionPercent: number;
}

export type VictoryPhase =
  | "fade-in"        // 1s: dark overlay fades in
  | "text-sequence"  // ~10s: typewriter lines appear one by one
  | "stats"          // stats fade in after text
  | "thanks"         // "Thank you for playing" message
  | "wait-for-key"   // "Press any key to return to title"

export class VictoryScreen {
  private phase: VictoryPhase = "fade-in";
  private phaseTimer: number = 0;
  private stats: VictoryStats;
  private textLines: string[];
  private visibleLines: number = 0;
  private charIndex: number = 0;
  private statsAlpha: number = 0;
  private thanksAlpha: number = 0;
  private waitAlpha: number = 0;
  private anyKeyPressed: boolean = false;
  done: boolean = false;  // true when player presses a key at the end

  constructor(stats: VictoryStats) { ... }

  update(dt: number, anyKeyDown: boolean): void { ... }

  render(ctx: CanvasRenderingContext2D, width: number, height: number): void { ... }
}
```

**Phase timing:**

| Phase | Duration | What happens |
|-------|----------|--------------|
| `fade-in` | 1.0s | Black overlay alpha goes 0 → 1 |
| `text-sequence` | ~10s | Typewriter reveal of 4 lines, 2.5s each |
| `stats` | 2.0s | Stats block fades in (alpha 0→1) |
| `thanks` | 2.0s | "Thank you for playing" fades in |
| `wait-for-key` | ∞ | "Press any key" blinks, waits for input |

**Text lines (typewriter style):**
1. `"The corruption recedes..."`
2. `"The Library breathes again."`
3. `"You have restored the Index."`
4. `"${playerName}, Keeper of the Archive"`

Each line appears character by character at ~30 chars/second (typewriter speed). After all characters of a line are visible, pause 0.8s, then start the next line.

**Stats display:**
```
 Play Time:      12:34
 Deaths:         7
 Rooms Visited:  42/46
 Abilities:      4/4
 Cards:          3
 Completion:     87%
```

Render centered, using monospace font, warm parchment colors (`#f5e6d3` for text, `#d4a76a` for values).

**Render style:**
- Background: solid black (or very dark warm brown `#0d0907`)
- Main text: warm parchment `#f5e6d3`, font `"bold 28px monospace"` for story lines
- Player name line: gold `#f59e0b`, font `"bold 24px monospace"`
- Stats: `16px monospace`, labels in `#c4a882`, values in `#f5e6d3`
- "Thank you for playing Inkbinders": `20px monospace`, `#e2e8f0`
- "Press any key to return to title": `14px monospace`, blinking alpha (sin wave)

**`update(dt, anyKeyDown)` logic:**
- `fade-in`: increment `phaseTimer`, when ≥ 1.0s move to `text-sequence`
- `text-sequence`: advance `charIndex` by `dt * 30` (30 chars/sec). When a line is complete, pause 0.8s, then increment `visibleLines`. When all 4 lines done, move to `stats`
- `stats`: fade `statsAlpha` from 0→1 over 2s, then move to `thanks`
- `thanks`: fade `thanksAlpha` from 0→1 over 2s, then move to `wait-for-key`
- `wait-for-key`: if `anyKeyDown`, set `done = true`

**`render(ctx, width, height)` logic:**
- Fill entire canvas with background color (alpha controlled by fade-in phase)
- Draw visible text lines centered vertically in upper half
- Current line uses partial text (substring by `charIndex`)
- Stats block rendered below text lines when `statsAlpha > 0`
- "Thank you" below stats when `thanksAlpha > 0`
- "Press any key" at bottom when in `wait-for-key` phase

### 2. Wire victory detection into play page

**File: `src/app/play/page.tsx`**

#### 2a. Add victory state variables

In the `handleMount` function, alongside other state variables:

```typescript
let victoryTriggered = false;
let victoryScreen: VictoryScreen | null = null;
```

#### 2b. Victory condition check — on room transition

In the room transition completion handler (around line 810, after `session.enterRoom(result.roomId, newRoomName)`), add:

```typescript
// Victory check: all 3 main bosses defeated + entered hub
if (!victoryTriggered && result.roomId === "scribe-hall") {
  const defeated = session.getState().defeatedBosses;
  const allBossesDefeated =
    defeated.includes("footnote-giant") &&
    defeated.includes("misprint-seraph") &&
    defeated.includes("index-eater");
  if (allBossesDefeated) {
    victoryTriggered = true;
    const state = session.getState();
    victoryScreen = new VictoryScreen({
      playerName: state.playerName,
      playTimeSeconds: state.totalPlayTime,
      deaths: state.deathCount,
      roomsVisited: state.visitedRooms.length,
      totalRooms: 46, // total rooms in the full world
      abilitiesUnlocked: state.unlockedAbilities.length,
      cardsCollected: state.cardDeckData?.ownedCards.length ?? 0,
      completionPercent: state.completionPercent,
    });
    // Show the "library restored" notification before the victory screen takes over
    hud.notify("The Library is Restored", "info");
  }
}
```

#### 2c. Also check on boss defeat (immediate notification)

In the boss defeat detection block (around line 1268), after `hud.notify("Boss defeated — gate opened!", "gate")`, add:

```typescript
// Check if this was the final boss
const defeated = session.getState().defeatedBosses;
if (
  defeated.includes("footnote-giant") &&
  defeated.includes("misprint-seraph") &&
  defeated.includes("index-eater")
) {
  hud.notify("The Library is Restored — return to the Scribe Hall", "info");
}
```

This gives the player direction after the final boss without immediately triggering the ending (they need to return to the hub first).

#### 2d. Victory screen in update loop

At the TOP of the `engine.onUpdate` callback, before the pause check:

```typescript
// Victory screen update — takes priority over everything
if (victoryScreen) {
  // Check for any key press
  const anyKey = input.isPressed("jump") || input.isPressed("attack") ||
    input.isPressed("dash") || input.isPressed("pause") ||
    input.isPressed("left") || input.isPressed("right");
  victoryScreen.update(dt, anyKey);
  if (victoryScreen.done) {
    engine.stop();
    router.push("/");
  }
  return; // Skip all game logic
}
```

#### 2e. Victory screen rendering

In `screenLayerCallback`, AFTER the pause menu render (so it draws on top of everything):

```typescript
// Victory screen overlay (renders on top of everything)
if (victoryScreen) {
  victoryScreen.render(ctx, canvas.width, canvas.height);
}
```

The victory screen should draw last so it covers the HUD, pause menu, and everything else.

#### 2f. Auto-save before victory screen

Right before creating the VictoryScreen in step 2b, trigger an auto-save so the player's final state is preserved:

```typescript
if (allBossesDefeated) {
  // Auto-save final state
  doSave().catch(() => {}); // fire-and-forget, don't block victory

  victoryTriggered = true;
  // ... rest of victory setup
}
```

### 3. Prevent re-triggering

The `victoryTriggered` flag prevents re-triggering within a session. But what about loading a save after victory? The save already records all bosses as defeated. On subsequent loads where all bosses are defeated:

- The victory screen should NOT auto-trigger on load — only on entering the hub
- Add a check: if the player is already in `scribe-hall` when the game loads with all bosses defeated, don't auto-trigger. Only trigger when the player physically transitions into the hub.
- The room transition completion handler (step 2b) only fires on transitions, not on initial load, so this is handled automatically.

## Files to Create

1. **`src/engine/ui/VictoryScreen.ts`** — VictoryScreen class (pure engine, no React)

## Files to Modify

1. **`src/app/play/page.tsx`** — Victory detection, VictoryScreen wiring, render integration

## Verification

1. **Type check:** `npx tsc --noEmit` passes
2. **Final boss notification:** Defeat the 3rd boss → notification "The Library is Restored — return to the Scribe Hall" appears
3. **Victory trigger:** Return to Scribe Hall after all 3 bosses defeated → 1s pause → victory screen fades in
4. **Text sequence:** Story lines appear in typewriter style, one by one
5. **Stats display:** Play time, deaths, rooms, abilities, cards, completion % all show correct values
6. **Player name:** The 4th text line shows the player's name
7. **Press any key:** After all text and stats appear, "Press any key to return to title" blinks
8. **Return to title:** Press any key → navigates to `/` (title screen)
9. **No re-trigger:** Start a new session, immediately go to hub → no victory screen (bosses not defeated)
10. **Auto-save:** Victory auto-saves, so reloading shows the completed save data
11. **Tide Scribe / Elder Binder NOT required:** Mini-bosses being undefeated does not prevent victory

---

## Implementation Summary

### Files Created
- **`src/engine/ui/VictoryScreen.ts`** — Pure TypeScript victory screen with 5-phase sequence: fade-in → typewriter text → stats fade-in → "thank you" → press-any-key. Uses `SaveSystem.formatPlayTime()` for time formatting. Warm parchment color palette matching the game's aesthetic.

### Files Modified
- **`src/engine/ui/index.ts`** — Added exports for `VictoryScreen`, `VictoryStats`, `VictoryPhase`
- **`src/app/play/page.tsx`** — Wired in VictoryScreen:
  - Import `VictoryScreen`
  - Added `victoryTriggered` and `victoryScreen` state variables
  - Victory screen update at top of update loop (takes priority over all game logic, early-returns)
  - Victory detection in room transition handler: checks if all 3 main bosses defeated when entering scribe-hall
  - Auto-save before triggering victory screen
  - "Final boss" notification on boss defeat when all 3 are down ("return to Scribe Hall")
  - Victory screen renders in screen-space layer callback, on top of everything (HUD, pause menu)
  - `rooms.size` used for total room count (dynamic, not hardcoded)
  - No re-trigger on load: only fires on room transition into hub, not on initial load

### Type check: `npx tsc --noEmit` passes clean

---

## Review Notes

**Reviewed by:** 0817aa10

**Fix applied:**
- `src/app/play/page.tsx`: Added `InputAction.Up` and `InputAction.Down` to the "any key" check for the victory screen. The original check only covered Jump, Attack, Dash, Pause, Left, Right — missing Up/Down. Since the prompt says "Press any key to return to title", all directional inputs should work.

**No other issues found.** Implementation is clean:
- VictoryScreen phase machine is complete with no stuck states
- All timing uses `dt` (no frame-rate dependent logic)
- `ctx.save()`/`ctx.restore()` properly brackets rendering
- `charIndex` float accumulation with `Math.floor()` for substring is correct
- Victory only triggers on room transition into hub (not on load), preventing re-trigger
- Auto-save fires before victory screen creation
- Victory screen renders last in layer callback (on top of everything)
- TypeScript types are clean, no `any` escape hatches
