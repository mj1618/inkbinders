# Task: Paste-Over — Surface Property Transfer

## Overview

Implement the **Paste-Over** ability and its test page (`/test/paste-over`). This is the third of four editing abilities (Phase 2, step 11). While Margin Stitch creates passages and Redaction erases obstacles, Paste-Over **changes how surfaces behave** — the player copies a surface property from one platform and pastes it onto another.

The metaphor: the player is copy-pasting formatting from one page of the manuscript to another. A bouncy mushroom-parchment surface gets pasted onto a flat stone wall, turning it into a trampoline. An icy margin coating gets pasted onto a sticky floor, making it slippery. This ability transforms how the player moves through existing geometry rather than adding or removing geometry.

This is the most mechanically rich editing ability because it requires the engine to support **surface types** — platforms are no longer just collision rectangles, they now have physical properties that modify how the player interacts with them. This is foundational infrastructure that will be reused by biomes (each biome has its own movement texture).

**Dependencies:**
- Margin Stitch must be complete (establishes ability system patterns, input bindings)
- Redaction should be complete (establishes obstacle/hazard patterns), but isn't a hard blocker
- The existing movement system (ground physics, jumping) must be solid — Paste-Over modifies these physics

## What to Build

### 1. Surface Types System (`src/engine/physics/Surfaces.ts`)

This is new engine infrastructure. Every platform can have a surface type that modifies player physics when the player is grounded on it (or touching its wall for wall surfaces).

```typescript
export type SurfaceType = 'normal' | 'bouncy' | 'icy' | 'sticky' | 'conveyor';

export interface SurfaceProperties {
  /** Type identifier */
  type: SurfaceType;
  /** Multiplier applied to player acceleration while on this surface (1.0 = normal) */
  accelerationMultiplier: number;
  /** Multiplier applied to player deceleration/friction (1.0 = normal) */
  frictionMultiplier: number;
  /** Multiplier applied to max run speed on this surface (1.0 = normal) */
  maxSpeedMultiplier: number;
  /** Bounce coefficient: velocity.y is multiplied by -bounce on landing (0 = no bounce) */
  bounce: number;
  /** Conveyor velocity added to the player's position each frame (px/s). 0 for non-conveyor. */
  conveyorSpeed: number;
  /** Whether the player can wall-slide on this surface type */
  wallSlidable: boolean;
  /** Multiplier for wall-slide friction (1.0 = normal grip) */
  wallFrictionMultiplier: number;
  /** Visual color for this surface type */
  color: string;
  /** Label for debug display */
  label: string;
}

export const SURFACE_PROPERTIES: Record<SurfaceType, SurfaceProperties> = {
  normal: {
    type: 'normal',
    accelerationMultiplier: 1.0,
    frictionMultiplier: 1.0,
    maxSpeedMultiplier: 1.0,
    bounce: 0,
    conveyorSpeed: 0,
    wallSlidable: true,
    wallFrictionMultiplier: 1.0,
    color: '#4ade80',    // Green (same as existing platforms)
    label: 'Normal',
  },
  bouncy: {
    type: 'bouncy',
    accelerationMultiplier: 0.8,
    frictionMultiplier: 0.6,
    maxSpeedMultiplier: 1.0,
    bounce: 0.85,        // 85% velocity preserved on bounce — feels super responsive
    conveyorSpeed: 0,
    wallSlidable: true,
    wallFrictionMultiplier: 0.3,  // Bounces off walls too (less grip)
    color: '#f472b6',    // Pink
    label: 'Bouncy',
  },
  icy: {
    type: 'icy',
    accelerationMultiplier: 0.25,   // Very slow to build speed
    frictionMultiplier: 0.08,       // Almost no friction — slide forever
    maxSpeedMultiplier: 1.5,        // Can reach higher speeds
    bounce: 0,
    conveyorSpeed: 0,
    wallSlidable: true,
    wallFrictionMultiplier: 0.15,   // Very little wall grip
    color: '#67e8f9',    // Cyan/ice blue
    label: 'Icy',
  },
  sticky: {
    type: 'sticky',
    accelerationMultiplier: 1.5,    // Quick acceleration (grip)
    frictionMultiplier: 4.0,        // Stop almost instantly
    maxSpeedMultiplier: 0.5,        // Much slower max speed
    bounce: 0,
    conveyorSpeed: 0,
    wallSlidable: true,
    wallFrictionMultiplier: 5.0,    // Can grip walls almost indefinitely
    color: '#a78bfa',    // Purple
    label: 'Sticky',
  },
  conveyor: {
    type: 'conveyor',
    accelerationMultiplier: 1.0,
    frictionMultiplier: 1.0,
    maxSpeedMultiplier: 1.0,
    bounce: 0,
    conveyorSpeed: 150,             // 150 px/s push (about half max run speed)
    wallSlidable: true,
    wallFrictionMultiplier: 1.0,
    color: '#fb923c',    // Orange
    label: 'Conveyor',
  },
};

/** Get the surface properties for a given type, defaulting to normal */
export function getSurfaceProps(type: SurfaceType | undefined): SurfaceProperties {
  return SURFACE_PROPERTIES[type ?? 'normal'];
}
```

### 2. Platform Surface Extension

Extend the `Platform` interface in `TileMap.ts` to support surface types:

```typescript
export interface Platform {
  x: number;
  y: number;
  width: number;
  height: number;
  /** Surface type — affects player physics when touching this platform */
  surfaceType?: SurfaceType;
  /** Original surface type before any paste-over was applied */
  originalSurfaceType?: SurfaceType;
  /** Whether this platform currently has a pasted surface (temporary override) */
  isPastedOver?: boolean;
}
```

All existing platforms default to `surfaceType: undefined` (treated as `'normal'`). This is fully backward-compatible — existing test pages don't need to change.

### 3. Player Surface Response

The Player needs to respond to the surface it's standing on. **This is the most delicate part** — the modifications must feel natural and not break the existing movement feel.

**Approach:** Rather than modifying Player.ts directly with surface awareness (which would add coupling), create a `SurfaceModifier` utility that the test page applies between the player's state machine update and the collision resolution. The modifier adjusts effective physics values based on the current surface.

Actually — simpler approach: expose a `currentSurface: SurfaceProperties` field on the Player that the test page (or later, the game loop) sets each frame based on what platform the player is grounded on. The Player's state handlers read from this to modify their physics.

Add to `Player`:
```typescript
/** The surface the player is currently standing on / touching */
currentSurface: SurfaceProperties = SURFACE_PROPERTIES.normal;
```

Modify the RUNNING state's acceleration logic to use surface multipliers:
```typescript
// In RUNNING state update:
const surface = player.currentSurface;
const accel = turning
  ? player.params.acceleration * player.params.turnMultiplier * surface.accelerationMultiplier
  : player.params.acceleration * surface.accelerationMultiplier;

let effectiveMaxSpeed = player.params.maxRunSpeed * surface.maxSpeedMultiplier;
// ... existing dash boost logic applied on top ...
```

Modify deceleration (IDLE state) to use surface friction:
```typescript
// In IDLE state update (deceleration):
const surface = player.currentSurface;
const decel = player.params.deceleration * surface.frictionMultiplier;
```

Modify JUMPING/FALLING landing logic for bouncy surfaces:
```typescript
// In resolveCollisions result handling:
if (result.grounded && surface.bounce > 0 && Math.abs(player.velocity.y) > 50) {
  player.velocity.y = -Math.abs(player.velocity.y) * surface.bounce;
  player.grounded = false;
  // Don't transition to landing — bounce!
}
```

Add conveyor effect to the ground movement update:
```typescript
// Applied when grounded on a conveyor surface:
if (surface.conveyorSpeed !== 0) {
  player.velocity.x += surface.conveyorSpeed * dt;
  // Still clamp to some max
}
```

Modify wall-slide friction for surface types:
```typescript
// In WALL_SLIDING state:
const wallSurface = player.currentWallSurface;
const effectiveBaseSpeed = player.params.wallSlideBaseSpeed / wallSurface.wallFrictionMultiplier;
const effectiveGripSpeed = player.params.wallSlideGripSpeed / wallSurface.wallFrictionMultiplier;
```

**Important: Add a `currentWallSurface` field too** — the surface the player is sliding against on a wall. The test page sets this based on `isTouchingWall` checks against platforms with surface types.

### 4. Surface Detection Helper

Add to `TileMap`:
```typescript
/** Get the surface type of the platform the entity is grounded on */
getGroundSurface(entity: { position: Vec2; size: Vec2 }): SurfaceType | undefined {
  // Check a thin probe rect below the entity's feet
  const probe: Rect = {
    x: entity.position.x + 2,
    y: entity.position.y + entity.size.y,
    width: entity.size.x - 4,
    height: 2,
  };
  for (const p of this.platforms) {
    if (aabbOverlap(probe, p)) {
      return p.surfaceType;
    }
  }
  return undefined;
}

/** Get the surface type of the wall the entity is touching on a given side */
getWallSurface(entity: { position: Vec2; size: Vec2 }, side: -1 | 1): SurfaceType | undefined {
  const probe: Rect = side === 1
    ? { x: entity.position.x + entity.size.x, y: entity.position.y + 1, width: 2, height: entity.size.y - 2 }
    : { x: entity.position.x - 2, y: entity.position.y + 1, width: 2, height: entity.size.y - 2 };
  for (const p of this.platforms) {
    if (aabbOverlap(probe, p)) {
      return p.surfaceType;
    }
  }
  return undefined;
}
```

### 5. Paste-Over Ability System (`src/engine/abilities/PasteOver.ts`)

The Paste-Over ability works in two steps:

**Step 1 — Copy:** Player stands on (or near) a surface with a non-normal type and presses the Copy key. The surface type is captured into a "clipboard."

**Step 2 — Paste:** Player moves to any other platform and presses the Paste key. The clipboard surface type is applied to that platform temporarily.

**Design decision: two separate keys or one toggle?**
Use **one key that toggles between copy and paste mode.** When the clipboard is empty, pressing the ability key copies. When the clipboard has a surface, pressing it pastes. This is intuitive and requires only one button.

Actually — even simpler: **auto-copy from the surface you're standing on, press to paste.** The clipboard always holds the surface type of the last non-normal surface the player touched. Press the ability key to paste that surface onto the platform you're currently on. This is zero-setup — no explicit copy step. The player just walks over a bouncy platform, then walks to a normal platform and presses the key to make it bouncy.

Go with auto-copy. It's faster, more intuitive, and maintains flow.

```typescript
export interface PasteOverParams {
  /** Maximum distance from player to paste onto a platform (px) — effectively unlimited if standing on it */
  maxPasteRange: number;
  /** Duration the pasted surface stays active (seconds) */
  pasteDuration: number;
  /** Cooldown after a paste expires before another can be placed (seconds) */
  pasteCooldown: number;
  /** Maximum number of simultaneously active paste-overs */
  maxActivePastes: number;
  /** Whether the ability is unlocked/available */
  enabled: boolean;
}

export const DEFAULT_PASTE_OVER_PARAMS: PasteOverParams = {
  maxPasteRange: 48,        // Must be close to the platform (basically standing on it or adjacent)
  pasteDuration: 8.0,       // 8 seconds — generous, since the player needs time to use the altered surface
  pasteCooldown: 2.0,       // 2 seconds cooldown
  maxActivePastes: 3,       // Can have 3 active paste-overs at once — allows chaining
  enabled: true,
};

export interface ActivePasteOver {
  /** The platform being modified */
  platform: Platform;
  /** The surface type pasted onto it */
  pastedSurface: SurfaceType;
  /** The original surface type (to restore on expiry) */
  originalSurface: SurfaceType | undefined;
  /** Remaining duration in seconds */
  remainingTime: number;
  /** Total duration (for visual fade calculations) */
  totalDuration: number;
}

export class PasteOver {
  params: PasteOverParams;

  /** The currently "copied" surface type (auto-captured from last non-normal surface) */
  clipboard: SurfaceType | null = null;

  /** Currently active paste-overs */
  activePastes: ActivePasteOver[] = [];

  /** Cooldown timer (seconds remaining) */
  cooldownTimer: number = 0;

  /** The platform the player could paste onto right now (for targeting highlight) */
  targetPlatform: Platform | null = null;

  /** Whether the ability can be activated right now */
  get canActivate(): boolean {
    return (
      this.params.enabled &&
      this.clipboard !== null &&
      this.targetPlatform !== null &&
      this.cooldownTimer <= 0 &&
      this.activePastes.length < this.params.maxActivePastes
    );
  }

  /**
   * Auto-copy: capture the surface type the player is currently on.
   * Called every frame. Only copies non-normal surfaces.
   */
  autoCapture(groundSurfaceType: SurfaceType | undefined): void;

  /**
   * Scan for the platform the player could paste onto.
   * Uses a foot probe to find the ground platform.
   * Call every frame.
   */
  scanForTarget(playerPosition: Vec2, playerSize: Vec2, tileMap: TileMap): void;

  /**
   * Activate paste-over on the target platform.
   * Returns true if activation succeeded.
   */
  activate(): boolean;

  /**
   * Update timers (active paste durations, cooldown).
   * Restores original surface types on expiry.
   * Call every physics frame.
   */
  update(dt: number): void;

  /**
   * Render paste-over visuals.
   * Call during render.
   */
  render(renderer: Renderer, camera: Camera): void;
}
```

### 6. Input Binding

Paste-Over uses `Ability1` (E key) in its test page. In the real game, the player would equip abilities to slots. For the test page, E = Paste-Over (since we're testing it in isolation).

If both Ability1 and Ability2 are already bound from Margin Stitch/Redaction tasks, add `Ability3`:

```typescript
Ability3: "ability3",  // Paste-Over
```

Default key binding: `r` (R for "rewrite" — thematic and reachable).

**Actually — check what's available.** If `Ability1` = E (stitch) and `Ability2` = Q (redaction), add:
```typescript
Ability3: "ability3",
```
Bind to `r` key in `DEFAULT_KEY_MAP`.

The test page maps Ability3 input to `pasteOver.activate()`.

### 7. Visual Design

Paste-Over visuals should evoke "copy-paste formatting" — think highlighting text and stamping it elsewhere:

**Clipboard indicator (HUD, screen space):**
- Small icon in the top-left showing the currently copied surface type
- Color-coded box matching the surface color (pink = bouncy, cyan = icy, etc.)
- Label: "Clipboard: [type]" or "Clipboard: Empty"
- Pulses briefly when a new surface is auto-copied

**Targeting visuals (when standing on a pasteable platform):**
- The platform under the player gets a dashed outline in the clipboard surface's color
- A small "paste" icon (downward arrow) appears above the platform
- Subtle pulsing at 40% opacity

**Active paste-over visuals:**
- The platform's fill color changes to the pasted surface color (replacing the normal green)
- A thin animated border in the surface color (to distinguish from naturally-typed surfaces)
- Timer bar below the platform showing remaining duration
- Surface-specific visual effects:
  - **Bouncy:** Small upward arrows/chevrons along the top surface, gentle bounce animation
  - **Icy:** Diagonal hatch lines (ice crystal pattern), slight shimmer
  - **Sticky:** Dots/stipple pattern on the surface, drip marks on edges
  - **Conveyor:** Animated arrows pointing in the conveyor direction, moving chevron pattern

**Auto-copy visual:**
- When the player walks onto a non-normal surface, a brief "copy" flash appears (small upward arrow from the surface to the clipboard indicator)
- Tiny particle burst at the player's feet in the surface color

**Expiration visual:**
- The pasted surface color fades out over the last 1 second
- The platform's color lerps back to the original
- Small "dissolve" particle burst when it fully expires

**Colors:**
- Normal: `#4ade80` (green)
- Bouncy: `#f472b6` (pink)
- Icy: `#67e8f9` (cyan)
- Sticky: `#a78bfa` (purple)
- Conveyor: `#fb923c` (orange)
- Timer bar: surface color → darkened version as time runs out
- Clipboard indicator background: `#1f2937` (dark gray)

### 8. Test Page (`/test/paste-over`)

Replace the stub with a full test page.

**Test Level Layout (1920×540, scrolling — 2x canvas width to have room for all surface types):**

The level is designed as a series of "zones" that each showcase a surface type, with normal platforms connecting them. The camera follows the player horizontally.

```
Zone 1: Source Surfaces (x: 0–480)
┌────────────────────────────────────────────────────────┐
│  START                                                  │
│  ═══════  ▓▓▓▓▓▓▓▓  ░░░░░░░░  ████████  ▒▒▒▒▒▒▒▒    │
│  normal   bouncy     icy        sticky     conveyor→   │
│                                                         │
│  These are the "source" platforms the player walks      │
│  over to auto-copy their surface type.                  │
│                                                         │
│  ══════════════════════════════════════════════════════  │ ← ground
└────────────────────────────────────────────────────────┘

Zone 2: Paste Targets — Bouncy (x: 480–960)
┌────────────────────────────────────────────────────────┐
│                                                         │
│                         ┌────┐  HIGH PLATFORM (goal)    │
│                         │    │  (only reachable by      │
│                         └────┘   bouncing)              │
│         ┌──────────┐                                    │
│         │ TARGET A │  ← paste bouncy here to reach      │
│         │ (normal) │    the high platform                │
│         └──────────┘                                    │
│                                                         │
│  ══════════════════════════════════════════════════════  │
└────────────────────────────────────────────────────────┘

Zone 3: Paste Targets — Icy (x: 960–1440)
┌────────────────────────────────────────────────────────┐
│                                                         │
│     ┌──┐        ┌──┐        ┌──┐                       │
│     │  │        │  │        │  │  SPEED RUN PLATFORMS   │
│     └──┘        └──┘        └──┘  (spaced so normal     │
│                                    speed can't reach,    │
│                                    icy speed boost can)  │
│  ════════════════════════════════                        │
│  long normal platform → paste icy for speed run          │
│                                                         │
│  ══════════════════════════════════════════════════════  │
└────────────────────────────────────────────────────────┘

Zone 4: Paste Targets — Sticky + Walls (x: 1440–1920)
┌────────────────────────────────────────────────────────┐
│                                                         │
│  ┌──┐                                           ┌──┐   │
│  │  │  TALL WALLS with slippery surface          │  │   │
│  │  │  Player slides down too fast normally.     │  │   │
│  │  │  Paste STICKY to grip the wall and         │  │   │
│  │  │  wall-jump up.                             │  │   │
│  │  │                                     GOAL→  │  │   │
│  │  │                                     ┌──┐   │  │   │
│  │  │                                     └──┘   │  │   │
│  └──┘                                           └──┘   │
│                                                         │
│  ═════════════════════════ ▒▒▒▒▒▒▒▒▒▒ ════════════════  │
│  normal ground             conveyor→    normal ground   │
│  (conveyor pushes player toward the wall challenge)     │
└────────────────────────────────────────────────────────┘
```

**Level elements in detail:**

1. **Source platforms strip** (x: 60–440, y: 440) — Five small platforms in a row, each with a different surface type: normal (80px), bouncy (80px), icy (80px), sticky (80px), conveyor (80px). These are the "color palette" the player copies from. Spaced with 10px gaps.

2. **Bounce challenge** (x: 560–720):
   - A normal platform (160px wide) at y: 380 (above the floor)
   - A high platform at y: 200 that's only reachable by bouncing
   - Player must: copy bouncy from zone 1, paste onto the normal platform, then jump on it to bounce up

3. **Speed run challenge** (x: 960–1380):
   - A long normal platform at y: 440 (240px wide)
   - Three small platforms (40px wide each) spaced 120px apart in the air at y: 360
   - The gap between the aerial platforms is too wide to reach at normal max speed
   - Player must: copy icy, paste onto the long platform, build up speed on the low-friction ice, then jump between the aerial platforms
   - The icy surface's `maxSpeedMultiplier: 1.5` lets the player reach the speed needed

4. **Wall grip challenge** (x: 1480–1860):
   - Two tall walls (20px wide, 300px tall) with `surfaceType: 'icy'` (pre-set, not normal)
   - These walls are naturally very slippery (`wallFrictionMultiplier: 0.15`)
   - A goal platform between the walls at y: 200, only reachable by wall-jumping up
   - Player must: copy sticky from zone 1, paste onto a wall to give it massive grip, then wall-jump up
   - This tests wall-surface paste-over (not just ground surfaces)

5. **Conveyor demo area** (x: 1500–1600):
   - A conveyor surface on the ground that pushes the player rightward
   - Player walks over it to copy conveyor, can paste it elsewhere to create push zones

6. **Ground floor** — continuous normal floor except where specific surfaces are placed

7. **Boundary walls + ceiling** — standard level bounds

**Debug Overlays (on canvas):**
- Player hitbox (cyan)
- All platform surfaces color-coded by type
- Clipboard indicator (top-left HUD)
- Target platform highlight (dashed outline when standing on a pasteable platform)
- Active paste-over timer bars below modified platforms
- Surface type labels on each platform
- Conveyor direction arrows (animated)
- Current surface properties readout near player (accel mult, friction mult, etc.)
- FPS counter, velocity, player state

**Debug Panel Sections (collapsible):**

1. **Paste-Over Info** (always visible):
   - Clipboard: [surface type] or "Empty"
   - Active pastes: count / max
   - Cooldown timer (if on cooldown)
   - Target platform: yes/no + surface type
   - Current standing surface: [type]
   - Current wall surface: [type] (if wall-sliding)

2. **Paste-Over Params** (expanded by default):
   | Parameter | Min | Max | Step | Default | Description |
   |-----------|-----|-----|------|---------|-------------|
   | Paste Range | 20 | 120 | 4 | 48 | Max distance to paste onto a platform |
   | Duration | 2.0 | 20.0 | 1.0 | 8.0 | How long paste lasts |
   | Cooldown | 0.0 | 10.0 | 0.5 | 2.0 | Cooldown after paste expires |
   | Max Active | 1 | 6 | 1 | 3 | Simultaneous active pastes |

3. **Surface Properties** (expanded by default):
   | Parameter | Min | Max | Step | Default | Description |
   |-----------|-----|-----|------|---------|-------------|
   | Bouncy: Bounce | 0.0 | 1.0 | 0.05 | 0.85 | Bounce coefficient |
   | Bouncy: Accel Mult | 0.1 | 2.0 | 0.1 | 0.8 | Acceleration multiplier |
   | Icy: Friction Mult | 0.01 | 1.0 | 0.01 | 0.08 | Friction multiplier |
   | Icy: Max Speed Mult | 0.5 | 3.0 | 0.1 | 1.5 | Max speed multiplier |
   | Sticky: Friction Mult | 1.0 | 10.0 | 0.5 | 4.0 | Friction multiplier |
   | Sticky: Max Speed Mult | 0.2 | 1.0 | 0.05 | 0.5 | Max speed multiplier |
   | Sticky: Wall Friction Mult | 1.0 | 10.0 | 0.5 | 5.0 | Wall grip multiplier |
   | Conveyor: Speed | 50 | 400 | 10 | 150 | Conveyor push speed (px/s) |

4. **Player State** (collapsed by default):
   - Current state, velocity, position, grounded, dash status
   - Effective accel, effective friction, effective max speed (after surface modifiers)
   - All movement params as sliders

5. **Controls** (expanded by default):
   - Reset Player button
   - Reset Params button
   - Reset All Surfaces button (clears all paste-overs)
   - Debug overlay toggle
   - Surface labels toggle

**Pass Criteria (display on page):**
1. Walking onto a bouncy/icy/sticky/conveyor platform auto-captures its type to the clipboard
2. Clipboard indicator updates in the HUD when a new surface is captured
3. Pressing R (Ability3) while standing on a normal platform pastes the clipboard surface
4. Pasted bouncy surface causes player to bounce on landing (velocity reflected)
5. Pasted icy surface reduces friction dramatically — player slides when stopping
6. Pasted icy surface allows reaching higher max speed
7. Pasted sticky surface increases friction — player stops almost instantly
8. Pasted sticky surface on a wall allows much slower wall-slide (strong grip)
9. Pasted conveyor surface pushes the player in the conveyor direction
10. Paste-over activates from any movement state without interrupting flow
11. Paste-over expires after the duration timer — surface restores to original
12. Visual timer bar shows remaining duration on each active paste-over
13. Player can have up to 3 active paste-overs simultaneously
14. Cooldown prevents immediate re-paste after one expires
15. Bounce challenge completable: paste bouncy → bounce to reach high platform
16. Speed challenge completable: paste icy → build speed → jump between platforms
17. Wall grip challenge completable: paste sticky on icy wall → wall-jump up

Auto-detection for criteria:
- 1: `clipboard` changes to non-null when stepping on non-normal surface
- 2: Visual (clipboard HUD updates)
- 3: `activePastes.length > 0` after pressing ability key on a normal platform
- 4: `velocity.y` becomes negative (upward) immediately after landing on bouncy surface
- 5: Player velocity > 10 for > 0.5s after releasing movement keys on icy surface
- 6: Player `velocity.x` exceeds `maxRunSpeed * 1.3` on icy surface
- 7: Player velocity reaches 0 within 0.1s of releasing keys on sticky surface
- 8: Wall-slide speed < `wallSlideGripSpeed * 0.3` on sticky wall surface
- 9: Player position.x changes by > 50px in 1s while idle on conveyor surface
- 10: Paste activates while player is in RUNNING / JUMPING / etc. (track source state)
- 11: Platform's `surfaceType` reverts to `originalSurfaceType` after timer
- 12: Visual check
- 13: `activePastes.length === 3` achieved
- 14: Activation fails during cooldown
- 15–17: Player reaches specific goal positions (goal markers at high platform, speed run end, wall challenge top)

**Keyboard Controls:**
| Key | Action |
|-----|--------|
| Arrow Left/Right | Move |
| Arrow Up / Z / Space | Jump |
| Arrow Down | Crouch |
| X / Shift | Dash |
| R | Paste surface from clipboard |
| D | Toggle debug overlays |

## Files to Create

- `src/engine/physics/Surfaces.ts` — Surface type definitions and properties
- `src/engine/abilities/PasteOver.ts` — Paste-Over ability system
- `src/app/test/paste-over/page.tsx` — Full test page (replace stub)

## Files to Modify

- `src/engine/physics/TileMap.ts` — Add `surfaceType`/`originalSurfaceType`/`isPastedOver` to `Platform` interface, add `getGroundSurface()` and `getWallSurface()` helpers
- `src/engine/physics/index.ts` — Export `Surfaces` types
- `src/engine/entities/Player.ts` — Add `currentSurface` and `currentWallSurface` fields, modify RUNNING/IDLE/WALL_SLIDING states to use surface multipliers, add bounce handling on landing
- `src/engine/abilities/index.ts` — Export PasteOver
- `src/engine/input/InputManager.ts` — Add `Ability3` action if not already present, bind to `r` key
- `src/lib/testStatus.ts` — Update paste-over status to `'in-progress'`
- `src/lib/constants.ts` — Add surface-related color constants if needed

## Important Implementation Notes

1. **Surface modifiers must be subtle enough to not break existing movement feel.** The base movement (without surface modifiers) must remain identical. Surface modifiers are multipliers on top of the existing physics — `1.0` = no change. Test by checking that all existing movement test pages still work with no surface-typed platforms.

2. **Backward compatibility is critical.** `surfaceType` on Platform is optional (`SurfaceType | undefined`). Undefined = normal. All existing test pages use platforms without surface types and must continue to work unchanged. The surface modifier code paths should have zero cost when the surface is normal (multiply by 1.0 is a no-op).

3. **Bouncy surface is the hardest to get right.** The bounce must feel satisfying, not frustrating. Key tuning: the bounce coefficient (0.85) means you gradually lose height, not bounce forever. The player must be able to hold Jump to boost the bounce (variable-height jump applies on top of the bounce velocity). The player must be able to land on a bouncy surface without bouncing by holding Down/Crouch.
   - **Bounce suppression:** If the player holds Down/Crouch while landing on a bouncy surface, suppress the bounce (treat as normal landing). This gives the player control.
   - **Minimum bounce threshold:** Only bounce if `|velocity.y| > 50`. Small touches don't bounce.

4. **Icy surface deceleration must not feel buggy.** The ultra-low friction means the player slides a long way after releasing keys. The IDLE state must handle this gracefully — don't snap to zero velocity, apply the reduced deceleration. The state should transition from RUNNING to IDLE normally, and IDLE should apply deceleration with the surface modifier. When on icy ground with no input, the player should slide to a gradual stop.

5. **Conveyor implementation:** The conveyor doesn't use velocity directly — it applies a constant force. The player can still move against the conveyor, but their effective speed is offset. Implementation: in the RUNNING/IDLE state, add `surface.conveyorSpeed * dt` to `velocity.x`. The player's input-driven acceleration/deceleration fights against or cooperates with this. Also needs a conveyor direction per-platform (for now, all conveyors push right; add `conveyorDirection?: 1 | -1` to Platform if needed, or derive from `conveyorSpeed` sign — positive = right, negative = left).

6. **Paste-over on walls requires extending the target scan.** The basic scan checks the ground platform (foot probe). For walls, check the wall the player is sliding against (side probe). The player should be able to paste onto walls while wall-sliding. This is important for the wall grip challenge.

7. **Zero flow interruption.** Like all editing abilities, paste-over activates on a single button press with no state change. The player keeps moving. The paste is applied instantly — the surface changes under the player's feet mid-step.

8. **Platform rendering must use surface colors.** Update `TileMap.render()` to color platforms based on their `surfaceType`. This is a visual change to TileMap that affects all test pages — but since existing platforms have `surfaceType: undefined` (= normal = green), the existing visual is preserved.

9. **Surface type is per-platform, not per-tile.** A single platform has one surface type. The player can't paste half a platform. This keeps the system simple and the visuals clear.

10. **Use the existing ParticleSystem** for paste-over particles (auto-copy flash, paste activation, expiration dissolve).

11. **Follow the existing test page pattern.** Use `GameCanvas`, `DebugPanel`, `Slider` components.

12. **The camera must follow the player horizontally** since the level is 1920px wide. Use the Camera from `src/engine/core/Camera.ts` — the movement playground should have established smooth-follow. If Camera doesn't have horizontal follow yet, add simple lerp-based following.

## Design Decisions (Pre-settled)

1. **Auto-copy, explicit paste.** No separate copy button. Walking on a special surface auto-captures it. The player presses R to paste. This is fast and intuitive.
2. **Clipboard holds one surface type.** Walking on a new surface overwrites the clipboard. Simple mental model.
3. **Duration-based paste.** The pasted surface reverts after a timer. Creates urgency and skill expression.
4. **Multiple active pastes (max 3).** Allows chaining — paste bouncy here, icy there, set up a route. But limited to prevent trivializing levels.
5. **Ground and wall surfaces.** Paste works on both ground platforms and wall surfaces. This is essential for the sticky-wall-grip mechanic.
6. **Surfaces modify physics via multipliers.** Clean separation — the surface system doesn't replace the movement code, it modifies parameters. The movement code stays intact.
7. **Bounce suppression with crouch.** Holding Down while landing on bouncy = normal landing. Gives the player control.
8. **Conveyor direction from speed sign.** Positive `conveyorSpeed` = push right, negative = push left. No extra field needed.

## Verification

- [ ] `npx tsc --noEmit` passes with zero errors
- [ ] `npm run build` succeeds
- [ ] Navigate to `/test/paste-over` — canvas renders with test level, source surfaces, and player
- [ ] Source platforms render in distinct colors (pink bouncy, cyan icy, purple sticky, orange conveyor)
- [ ] Walking on a non-normal surface updates the clipboard indicator
- [ ] Pressing R while standing on a normal platform applies the clipboard surface
- [ ] Pasted bouncy: player bounces on landing (velocity reflected upward)
- [ ] Pasted bouncy: holding Down suppresses bounce (normal landing)
- [ ] Pasted icy: dramatically reduced friction — player slides when releasing keys
- [ ] Pasted icy: player can reach higher max speed than normal
- [ ] Pasted sticky: dramatically increased friction — player stops almost instantly
- [ ] Pasted sticky on wall: much slower wall-slide speed (strong grip)
- [ ] Pasted conveyor: player is pushed in the conveyor direction while standing still
- [ ] Paste-over timer counts down and surface reverts on expiry
- [ ] Paste-over activates from any movement state without interruption
- [ ] Can have 3 active paste-overs at once
- [ ] Cooldown prevents immediate re-paste
- [ ] Bounce challenge: paste bouncy → reach high platform by bouncing ✓
- [ ] Speed challenge: paste icy → build speed → cross platform gaps ✓
- [ ] Wall grip challenge: paste sticky on icy wall → wall-jump up ✓
- [ ] All surface params are tunable via sliders
- [ ] Debug overlays: surface type labels, colors, timer bars, clipboard HUD, effective physics values
- [ ] All existing movement mechanics (run, jump, wall, dash) still work on normal surfaces
- [ ] Existing test pages unaffected (no visual or behavioral changes for normal platforms)
- [ ] Camera follows player horizontally across the 1920px level
- [ ] FPS stays at ~60fps
- [ ] Reset buttons work (player, params, surfaces)

---

## Implementation Summary

### Files Created
- `src/engine/physics/Surfaces.ts` — Surface type definitions (normal, bouncy, icy, sticky, conveyor) with `SurfaceProperties` interface containing multipliers for acceleration, friction, max speed, bounce, conveyor speed, wall friction
- `src/engine/abilities/PasteOver.ts` — Paste-Over ability system with auto-copy clipboard, explicit paste activation, duration-based paste-overs, targeting scan, visual rendering (target highlights, active paste timer bars, surface-specific effects), particle effects
- `src/app/test/paste-over/page.tsx` — Full test page replacing the stub, with scrolling 1920px level, 4 challenge zones (source surfaces, bounce challenge, speed challenge, wall grip challenge), 18 pass criteria with auto-detection, debug panel with paste-over params, surface property sliders, player movement sliders, and control buttons

### Files Modified
- `src/engine/physics/TileMap.ts` — Extended `Platform` interface with `surfaceType`, `originalSurfaceType`, `isPastedOver` fields. Added `getGroundSurface()`, `getWallSurface()`, `getGroundPlatform()`, `getWallPlatform()` helper methods. Updated `render()` to color-code platforms by surface type.
- `src/engine/entities/Player.ts` — Added `currentSurface` and `currentWallSurface` fields. Modified IDLE state deceleration with surface friction multiplier + conveyor push. Modified RUNNING state acceleration/max speed with surface multipliers + conveyor push. Modified WALL_SLIDING state with wall surface friction multiplier. Added bouncy surface bounce handling in FALLING landing logic (with crouch suppression and minimum velocity threshold).
- `src/engine/input/InputManager.ts` — Added `Ability3` action, bound to `r` key
- `src/engine/physics/index.ts` — Added exports for Surfaces types
- `src/engine/abilities/index.ts` — Added exports for PasteOver
- `src/lib/testStatus.ts` — Updated paste-over status to `in-progress`
- `AGENTS.md` — Updated Input Actions, Phase 2 progress, added Surface Types System and Paste-Over System documentation sections

### Verification
- `npx tsc --noEmit` — passes with zero errors
- `npm run build` — succeeds with all 27 routes generated
- Backward compatible — existing platforms without `surfaceType` render identically (normal = green)
- Surface modifiers use multipliers (1.0 = no change) so existing movement is unaffected

---

## Review Notes (d324f2e6)

### Issues Found and Fixed

1. **BUG (Critical): Bouncy surface bounce velocity overwritten by JUMPING enter handler**
   - **File:** `src/engine/entities/Player.ts`
   - **Problem:** When landing on a bouncy surface, the FALLING state's bounce code sets `velocity.y = -impactVelocity * bounce` then transitions to JUMPING. But the JUMPING enter handler checks `if (prev !== STATE_WALL_JUMPING)` — since prev is FALLING, it overwrites velocity.y with `-jumpSpeed`, destroying the bounce.
   - **Fix:** Added `isBouncing` flag to Player. Bounce code sets `isBouncing = true` before transitioning. JUMPING enter handler checks this flag first and skips the velocity override when bouncing. Also sets `jumpHeld = false` so jump-cut doesn't apply to bounces.

2. **BUG (Critical): Bounce velocity check always fails because collision resolution zeroes velocity.y**
   - **File:** `src/engine/entities/Player.ts`
   - **Problem:** The bounce check `Math.abs(player.velocity.y) > 50` runs in the FALLING state update, but by then collision resolution from the previous frame has already zeroed `velocity.y`. The check would always see `velocity.y ≈ 0`, making bounces impossible.
   - **Fix:** Added `preLandingVelocityY` field to Player that stores velocity.y just before collision resolution runs each frame. The bounce check now uses `player.preLandingVelocityY` instead of `player.velocity.y`.

3. **BUG (Gameplay): Conveyor doesn't push idle player — deceleration overpowers conveyor force**
   - **File:** `src/engine/entities/Player.ts` (IDLE state)
   - **Problem:** Conveyor push was additive (`velocity.x += conveyorSpeed * dt`), applied after deceleration. Since deceleration (1200/s) vastly exceeds conveyor speed (150/s), the player would jitter near zero instead of being smoothly pushed.
   - **Fix:** Changed IDLE state deceleration to target the conveyor speed instead of zero: `restSpeed = grounded ? conveyorSpeed : 0`. The deceleration now drives velocity toward the conveyor's push speed, so the player smoothly slides at conveyor speed when idle.

4. **Perf: `setPasteInfo` called every frame causing 60 React re-renders/second**
   - **File:** `src/app/test/paste-over/page.tsx`
   - **Problem:** `setPasteInfo()` was called every physics frame (60Hz), triggering a React state update and re-render each time. `setCriteria` was already throttled to every 10 frames.
   - **Fix:** Moved `setPasteInfo` into the same `frameCount % 10` throttle block as `setCriteria`.

5. **Minor: Misleading comment about D key toggle**
   - **File:** `src/app/test/paste-over/page.tsx`
   - **Problem:** Comment said "Toggle debug overlays with D key" but `D` is bound to `InputAction.Right` (movement). The actual toggle uses `InputAction.Attack` (j/Enter).
   - **Fix:** Updated comment to say "Toggle debug overlays with J/Enter key (Attack action)".

6. **Minor: Reset player doesn't reset `isBouncing` flag**
   - **File:** `src/app/test/paste-over/page.tsx`
   - **Fix:** Added `player.isBouncing = false` to the `resetPlayer` callback.

### No Issues Found In

- `src/engine/physics/Surfaces.ts` — Clean, well-structured surface type definitions
- `src/engine/abilities/PasteOver.ts` — Solid implementation: auto-capture, targeting, activation, timer management, visual rendering, particle effects all correct
- `src/engine/physics/TileMap.ts` — Surface helper methods (`getGroundSurface`, `getWallSurface`, `getGroundPlatform`, `getWallPlatform`) are correct. Surface-based platform coloring works. Backward compatible.
- `src/engine/input/InputManager.ts` — Ability3 added correctly
- Index/export files — All exports present and typed correctly
- RUNNING state surface multipliers — Applied correctly to acceleration, max speed, and conveyor push (clamped by effectiveMaxSpeed)
- WALL_SLIDING state wall surface friction — Division by wallFrictionMultiplier correctly reduces slide speed for high-friction walls

### Verification After Fixes
- `npx tsc --noEmit` passes with zero errors
- `npm run build` succeeds with all 27 routes
- No regressions: new Player fields (`preLandingVelocityY`, `isBouncing`) have safe defaults (0, false) and don't affect existing test pages
