# Task: Day/Night Cycle — Cozy Day / Chaotic Night Transitions

## Overview

Implement the **day/night cycle system** and its test page (`/test/day-night`). This is Phase 4, step 17. It introduces the temporal rhythm that is one of the game's three design pillars: "Cozy-by-day / chaos-by-night."

The day/night cycle is a **world-level system** that manages time progression, visual atmosphere, and corruption modifiers. During the day, the world is safe — warm lighting, gentle ambient effects, no corruption. At night, corruption creeps in — cool/harsh lighting, visual distortion, modifier effects that change gameplay (faster enemies, surface changes, hazard spawning).

**This task has NO dependency on Phase 3 (combat/enemies) or the Herbarium Folio biome.** It builds on Phase 1 movement and engine core only. The corruption modifiers are demonstrated with simple environmental hazards and surface changes in the test page — no combat integration needed.

## Dependencies

- Engine core (GameLoop, Renderer, Camera, ParticleSystem, ScreenShake) ✅
- Player + movement system ✅
- TileMap + Platform + Surface types ✅
- InputManager ✅

## What to Build

### 1. Day/Night Cycle System (`src/engine/world/DayNightCycle.ts`)

The core time management and atmosphere controller.

```typescript
export type TimeOfDay = 'dawn' | 'day' | 'dusk' | 'night';

export interface DayNightParams {
  /** Total cycle duration in seconds (real time for one full day+night) */
  cycleDuration: number;
  /** Fraction of cycle spent in day (0-1) */
  dayFraction: number;
  /** Duration of dawn transition in seconds */
  dawnDuration: number;
  /** Duration of dusk transition in seconds */
  duskDuration: number;
  /** Time speed multiplier (1.0 = normal, 2.0 = double speed) */
  timeScale: number;
  /** Whether the cycle auto-advances or is paused */
  running: boolean;
}

export const DEFAULT_DAY_NIGHT_PARAMS: DayNightParams = {
  cycleDuration: 120,     // 2 minutes for a full day+night (fast for testing)
  dayFraction: 0.5,       // 50% day, 50% night
  dawnDuration: 8,        // 8 seconds of dawn transition
  duskDuration: 8,        // 8 seconds of dusk transition
  timeScale: 1.0,
  running: true,
};
```

**Time model:**

The cycle is a normalized value `t` from 0.0 to 1.0:
- `0.0` = midnight (deepest night)
- `0.25` = dawn
- `0.5` = noon (brightest day)
- `0.75` = dusk
- `1.0` = midnight again (wraps)

More precisely, using `dayFraction` and transition durations:
- Night: `t` from 0 to `nightStart` and from `nightEnd` to 1.0
- Dawn: `t` from `nightEnd - dawnNorm` to `nightEnd`
- Day: `t` from `nightEnd` to `nightStart`
- Dusk: `t` from `nightStart` to `nightStart + duskNorm`

Where:
- `nightFraction = 1.0 - dayFraction`
- `nightStart = dayFraction + dawnNorm / 2`
- `nightEnd = dawnNorm / 2`
- `dawnNorm = dawnDuration / cycleDuration`
- `duskNorm = duskDuration / cycleDuration`

Simplify: just use a straightforward mapping where `dayFraction` of the cycle is "day" and the rest is "night," with dawn/dusk as transition periods overlapping the boundaries.

```typescript
export class DayNightCycle {
  params: DayNightParams;

  /** Normalized time (0.0 to 1.0, wraps) */
  time: number = 0.25;  // Start at dawn
  /** Current time of day */
  timeOfDay: TimeOfDay = 'dawn';
  /** Transition progress for dawn/dusk (0.0 = start of transition, 1.0 = end) */
  transitionProgress: number = 0;

  /** Corruption intensity (0.0 during day, ramps to 1.0 at deepest night) */
  corruptionIntensity: number = 0;

  /** Light level (0.0 = pitch dark, 1.0 = bright day) */
  lightLevel: number = 0.5;

  /** Current atmosphere colors (interpolated) */
  skyColor: string = '#1a1a2e';
  ambientColor: string = '#ffffff';
  fogColor: string = '#00000000';

  constructor(params?: Partial<DayNightParams>);

  /**
   * Advance time by dt seconds (real time × timeScale).
   * Updates timeOfDay, lightLevel, corruptionIntensity, atmosphere colors.
   */
  update(dt: number): void;

  /**
   * Get the current TimeOfDay based on normalized time.
   */
  getTimeOfDay(): TimeOfDay;

  /**
   * Get light level (0-1) based on current time.
   * Day = 1.0, Night = 0.15, Dawn/Dusk = interpolated.
   */
  getLightLevel(): number;

  /**
   * Get corruption intensity (0-1).
   * Day = 0, Night ramps from 0 to 1 based on how deep into night.
   * Dawn = fading from some corruption to 0.
   */
  getCorruptionIntensity(): number;

  /**
   * Get interpolated atmosphere colors for the current time.
   */
  getAtmosphere(): DayNightAtmosphere;

  /**
   * Set time to a specific normalized value (for debug controls).
   */
  setTime(t: number): void;

  /**
   * Skip to a specific time of day (dawn, day, dusk, night).
   */
  skipTo(timeOfDay: TimeOfDay): void;

  /**
   * Reset to dawn.
   */
  reset(): void;
}
```

### 2. Day/Night Atmosphere (`src/engine/world/DayNightAtmosphere.ts`)

Defines the visual palette for each time of day and handles interpolation.

```typescript
export interface DayNightAtmosphere {
  /** Background/sky color */
  backgroundColor: string;
  /** Global light tint (applied as a semi-transparent overlay) */
  lightTint: string;
  /** Ambient particle colors */
  ambientParticleColors: string[];
  /** Fog overlay color (rgba with alpha) */
  fogColor: string;
  /** Platform tint multiplier (darkens platforms at night) */
  platformDarkness: number;  // 0.0 = full bright, 1.0 = fully darkened
  /** Corruption visual intensity (0-1, controls corruption effects) */
  corruptionIntensity: number;
  /** Shadow opacity (0 = no shadows, 1 = full shadows) */
  shadowOpacity: number;
}

/** Color palette for each time of day */
export interface TimeColors {
  backgroundColor: string;
  lightTint: string;
  ambientParticleColors: string[];
  fogColor: string;
  platformDarkness: number;
  shadowOpacity: number;
}

export const DAY_COLORS: TimeColors = {
  backgroundColor: '#f0e6d3',        // Warm parchment
  lightTint: 'rgba(255, 248, 220, 0.08)',  // Warm golden overlay
  ambientParticleColors: ['#fbbf24', '#f59e0b', '#ffffff', '#fde68a'],  // Golden dust motes
  fogColor: 'rgba(0, 0, 0, 0)',      // No fog
  platformDarkness: 0.0,
  shadowOpacity: 0.15,
};

export const NIGHT_COLORS: TimeColors = {
  backgroundColor: '#0a0a1a',        // Deep dark blue-black
  lightTint: 'rgba(30, 27, 75, 0.15)',  // Deep indigo tint
  ambientParticleColors: ['#4338ca', '#6366f1', '#818cf8', '#1e1b4b'],  // Cold indigo sparks
  fogColor: 'rgba(10, 10, 26, 0.3)',  // Dark fog
  platformDarkness: 0.6,             // Platforms significantly darker
  shadowOpacity: 0.6,
};

export const DAWN_COLORS: TimeColors = {
  backgroundColor: '#2d1f3d',        // Purple-gray
  lightTint: 'rgba(244, 114, 182, 0.06)',  // Rosy pink tint
  ambientParticleColors: ['#f472b6', '#fb923c', '#fbbf24', '#a855f7'],  // Pink/orange
  fogColor: 'rgba(45, 31, 61, 0.1)',  // Light purple fog
  platformDarkness: 0.3,
  shadowOpacity: 0.3,
};

export const DUSK_COLORS: TimeColors = {
  backgroundColor: '#1a0f2e',        // Deep purple
  lightTint: 'rgba(234, 88, 12, 0.06)',  // Amber tint
  ambientParticleColors: ['#ea580c', '#dc2626', '#f59e0b', '#7c3aed'],  // Warm reds/oranges
  fogColor: 'rgba(26, 15, 46, 0.15)',  // Purple fog
  platformDarkness: 0.4,
  shadowOpacity: 0.4,
};

/**
 * Interpolate between two TimeColors palettes.
 * @param a - Start palette
 * @param b - End palette
 * @param t - Progress (0 = a, 1 = b)
 */
export function interpolateColors(a: TimeColors, b: TimeColors, t: number): DayNightAtmosphere;

/**
 * Linearly interpolate between two hex colors.
 */
export function lerpColor(a: string, b: string, t: number): string;

/**
 * Linearly interpolate between two rgba colors.
 */
export function lerpRgba(a: string, b: string, t: number): string;
```

### 3. Corruption Modifier System (`src/engine/world/CorruptionModifiers.ts`)

Corruption modifiers are gameplay effects that activate at night based on corruption intensity. They modify the world — surface properties, visual distortion, and environmental hazards.

```typescript
export type CorruptionModifierType =
  | 'surface-flip'      // Normal surfaces become icy, icy becomes bouncy, etc.
  | 'gravity-pulse'     // Brief gravity reversals
  | 'fog-of-war'        // Reduced visibility radius around the player
  | 'ink-bleed'         // Random ink particles spawn as visual noise
  | 'platform-flicker'; // Platforms visually flicker (don't actually disappear — just visual unease)

export interface CorruptionModifier {
  type: CorruptionModifierType;
  /** Minimum corruption intensity to activate (0-1) */
  threshold: number;
  /** Whether this modifier is currently active */
  active: boolean;
  /** Modifier-specific state */
  state: Record<string, unknown>;
}

export interface CorruptionParams {
  /** Whether corruption modifiers are enabled */
  enabled: boolean;
  /** Surface flip: which surface types change and to what */
  surfaceFlipMap: Record<string, string>;
  /** Gravity pulse: interval between pulses (seconds) */
  gravityPulseInterval: number;
  /** Gravity pulse: duration of each pulse (seconds) */
  gravityPulseDuration: number;
  /** Gravity pulse: gravity multiplier during pulse */
  gravityPulseMultiplier: number;
  /** Fog of war: visibility radius (px) at max corruption */
  fogMinRadius: number;
  /** Fog of war: visibility radius (px) at zero corruption */
  fogMaxRadius: number;
  /** Ink bleed: particles per second at max corruption */
  inkBleedRate: number;
  /** Platform flicker: flicker probability per frame per platform at max corruption */
  platformFlickerChance: number;
}

export const DEFAULT_CORRUPTION_PARAMS: CorruptionParams = {
  enabled: true,
  surfaceFlipMap: {
    'normal': 'icy',
    'icy': 'bouncy',
    'bouncy': 'sticky',
    'sticky': 'conveyor',
    'conveyor': 'normal',
  },
  gravityPulseInterval: 5.0,     // Every 5 seconds at max corruption
  gravityPulseDuration: 0.5,     // Half-second pulse
  gravityPulseMultiplier: -0.5,  // Gravity inverts briefly (reduced magnitude)
  fogMinRadius: 120,             // Tight visibility at deepest night
  fogMaxRadius: 600,             // Wide visibility fading in
  inkBleedRate: 8,               // 8 particles/sec at max corruption
  platformFlickerChance: 0.005,  // 0.5% per frame per platform at max
};

export class CorruptionModifiers {
  params: CorruptionParams;
  modifiers: CorruptionModifier[];

  /** Current corruption intensity (set by DayNightCycle) */
  corruptionIntensity: number = 0;

  /** Gravity pulse timer */
  gravityPulseTimer: number = 0;
  /** Whether a gravity pulse is currently active */
  gravityPulseActive: boolean = false;
  gravityPulseCurrent: number = 0;  // Time into current pulse

  /** Fog radius (interpolated based on corruption) */
  fogRadius: number = 600;

  /** Platform flicker states: maps platform index → whether it's "flickered" this frame */
  platformFlickers: Map<number, boolean> = new Map();

  constructor(params?: Partial<CorruptionParams>);

  /**
   * Update all corruption modifiers for one frame.
   * @param dt - Delta time in seconds
   * @param corruptionIntensity - Current corruption level (0-1)
   * @param platformCount - Number of platforms in the current level
   */
  update(dt: number, corruptionIntensity: number, platformCount: number): void;

  /**
   * Get the effective surface type for a platform given corruption.
   * If surface-flip is active and above threshold, returns the flipped surface.
   * Otherwise returns the original surface type.
   */
  getEffectiveSurface(originalSurface: string): string;

  /**
   * Get the current gravity multiplier (including any active pulse).
   * Returns 1.0 normally, or pulseMultiplier during a gravity pulse.
   */
  getGravityMultiplier(): number;

  /**
   * Get current fog-of-war radius.
   */
  getFogRadius(): number;

  /**
   * Whether a specific platform index is "flickering" this frame.
   */
  isPlatformFlickering(platformIndex: number): boolean;

  /**
   * Render corruption visual effects.
   * - Fog-of-war: radial gradient mask centered on player
   * - Ink bleed: spawn random ink particles
   * - Platform flicker: handled by the test page when rendering platforms
   */
  render(ctx: CanvasRenderingContext2D, playerScreenPos: Vec2, canvasWidth: number, canvasHeight: number): void;

  /** Reset all modifier state */
  reset(): void;
}
```

### 4. Day/Night Visual Renderer (`src/engine/world/DayNightRenderer.ts`)

Handles rendering the atmosphere — background gradient, light overlay, fog, and ambient particles. This is a rendering helper, not a system.

```typescript
export class DayNightRenderer {
  /**
   * Render the sky/background based on current atmosphere.
   */
  static renderBackground(ctx: CanvasRenderingContext2D, atmosphere: DayNightAtmosphere, canvasWidth: number, canvasHeight: number): void;

  /**
   * Render the light tint overlay (drawn after world, before debug).
   */
  static renderLightOverlay(ctx: CanvasRenderingContext2D, atmosphere: DayNightAtmosphere, canvasWidth: number, canvasHeight: number): void;

  /**
   * Render fog overlay.
   */
  static renderFog(ctx: CanvasRenderingContext2D, fogColor: string, canvasWidth: number, canvasHeight: number): void;

  /**
   * Render fog-of-war (radial visibility around player).
   * Creates a dark overlay with a transparent circle centered on the player.
   */
  static renderFogOfWar(ctx: CanvasRenderingContext2D, playerScreenPos: Vec2, radius: number, fogColor: string, canvasWidth: number, canvasHeight: number): void;

  /**
   * Render the clock/time HUD element.
   * A circular clock face showing current time, with day/night indicator.
   */
  static renderClockHUD(ctx: CanvasRenderingContext2D, time: number, timeOfDay: TimeOfDay, x: number, y: number, radius: number): void;

  /**
   * Render corruption visual distortion.
   * At high corruption: chromatic aberration effect (offset red/blue channels slightly).
   * Implemented by drawing the scene offset in red/blue at low alpha.
   */
  static renderCorruptionDistortion(ctx: CanvasRenderingContext2D, corruptionIntensity: number, canvasWidth: number, canvasHeight: number): void;
}
```

### 5. Test Page (`/test/day-night`)

Replace the stub with a full test page that demonstrates the complete day/night cycle with corruption modifiers.

**Test Level Layout (1920×540, 2× canvas width):**

A simple traversal level with varied surfaces, designed to showcase how the cycle affects gameplay and visuals. Not too complex — the focus is on the atmospheric and modifier effects, not level design mastery.

```
┌═══════════════════════════════════════════════════════════════════════════════════┐
│                                                                                   │
│  ☀/☾ clock HUD (top-right)                                                       │
│                                                                                   │
│                              ┌──────────┐                                        │
│          ┌────────┐          │ BOUNCY   │                                        │
│          │  ICY   │          │ Platform │          ┌────────────┐                │
│    ┌─────┘        └─────┐    └──────────┘    ┌─────┘            │                │
│    │  NORMAL Platform   │                     │  STICKY Platform│                │
│    └────────────────────┘                     └─────────────────┘                │
│                                                                                   │
│  START  ▮▮▮▮  CONVEYOR  ▮▮▮▮                    ▮▮▮▮  NORMAL  ▮▮▮▮   END        │
│  ████                                                                     ████   │
│                                                                                   │
│═══════════════════════════════════════════════════════════════════════════════════│
└═══════════════════════════════════════════════════════════════════════════════════┘
```

**Detailed Platform Layout:**

```typescript
const platforms: Platform[] = [
  // Ground floor (full width)
  { x: 0, y: 460, width: 1920, height: 80 },

  // === Left section — normal ground, elevated platforms ===
  // Normal elevated platform (wide)
  { x: 100, y: 360, width: 300, height: 20 },
  // Icy elevated platform
  { x: 160, y: 360, width: 180, height: 20, surfaceType: 'icy' as SurfaceType },

  // === Center section — bouncy platform, gap ===
  // Bouncy platform (high)
  { x: 620, y: 280, width: 160, height: 20, surfaceType: 'bouncy' as SurfaceType },

  // === Right section — sticky platform, more traversal ===
  // Sticky elevated platform
  { x: 1000, y: 340, width: 240, height: 20, surfaceType: 'sticky' as SurfaceType },

  // === Ground surface variations ===
  // Conveyor section on the ground floor
  { x: 300, y: 440, width: 200, height: 20, surfaceType: 'conveyor' as SurfaceType },

  // Additional platforms at various heights for testing
  { x: 500, y: 400, width: 100, height: 20 },
  { x: 1300, y: 380, width: 120, height: 20 },
  { x: 1500, y: 300, width: 100, height: 20 },
  { x: 1700, y: 360, width: 120, height: 20 },

  // === Walls (for wall-slide testing) ===
  { x: 880, y: 280, width: 20, height: 180 },    // Center wall
  { x: 1400, y: 200, width: 20, height: 260 },   // Right wall

  // Boundaries
  { x: 0, y: 0, width: 1920, height: 20 },       // Ceiling
  { x: 0, y: 0, width: 20, height: 540 },         // Left wall
  { x: 1900, y: 0, width: 20, height: 540 },      // Right wall
];
```

**Player spawn:** x=60, y=420

**Debug Overlays (on canvas):**
- Player hitbox (cyan outline)
- Current time-of-day label (top-left: "DAY", "DAWN", "DUSK", "NIGHT" with appropriate color)
- Clock HUD (top-right: circular dial showing time position, sun/moon icon)
- Light level readout (e.g., "Light: 0.85")
- Corruption intensity readout (e.g., "Corruption: 0.42")
- Active corruption modifiers list (e.g., "Surface Flip ✓ | Gravity Pulse ✓ | Fog ✓")
- Gravity pulse indicator (flashes when pulse active)
- Fog-of-war radius circle (when fog is active)
- Platform surface labels (show current effective surface, changes during corruption)
- Ambient particles (different colors per time of day)
- FPS counter, player state, velocity

**Debug Panel Sections:**

1. **Cycle Info** (always visible):
   - Time of Day: DAWN / DAY / DUSK / NIGHT
   - Normalized Time: 0.000 — 1.000
   - Light Level: 0.00 — 1.00
   - Corruption: 0.00 — 1.00
   - Cycle elapsed: X.Xs / {cycleDuration}s
   - Time Scale: X.Xx
   - Active Modifiers: (list)

2. **Time Controls** (expanded):
   | Parameter | Min | Max | Step | Default |
   |-----------|-----|-----|------|---------|
   | Cycle Duration | 20 | 600 | 10 | 120 |
   | Day Fraction | 0.2 | 0.8 | 0.05 | 0.5 |
   | Dawn Duration | 2 | 20 | 1 | 8 |
   | Dusk Duration | 2 | 20 | 1 | 8 |
   | Time Scale | 0.1 | 10.0 | 0.1 | 1.0 |
   - Pause/Resume toggle button
   - Skip to Dawn button
   - Skip to Day button
   - Skip to Dusk button
   - Skip to Night button
   - Manual time scrubber slider (0.0 — 1.0)

3. **Corruption Modifiers** (expanded):
   | Parameter | Min | Max | Step | Default |
   |-----------|-----|-----|------|---------|
   | Corruption Enabled | toggle | | | true |
   | Gravity Pulse Interval | 1.0 | 20.0 | 0.5 | 5.0 |
   | Gravity Pulse Duration | 0.1 | 2.0 | 0.1 | 0.5 |
   | Gravity Pulse Multiplier | -2.0 | 0.0 | 0.1 | -0.5 |
   | Fog Min Radius | 40 | 300 | 10 | 120 |
   | Fog Max Radius | 200 | 960 | 20 | 600 |
   | Ink Bleed Rate | 0 | 30 | 1 | 8 |
   | Platform Flicker Chance | 0.0 | 0.05 | 0.001 | 0.005 |
   - Per-modifier toggle: Surface Flip / Gravity Pulse / Fog of War / Ink Bleed / Platform Flicker

4. **Visual Settings** (collapsed):
   - Show ambient particles: toggle (default: true)
   - Show fog overlay: toggle (default: true)
   - Show clock HUD: toggle (default: true)
   - Show corruption distortion: toggle (default: true)
   - Ambient particle rate: slider (0–10, default: 3)

5. **Player State** (collapsed):
   - Standard movement params, state, velocity, position

**Pass Criteria (display on page):**

1. Day/night cycle advances automatically over time (120s default cycle)
2. Visual atmosphere transitions smoothly between 4 phases (dawn → day → dusk → night)
3. Background color interpolates correctly (warm parchment day → deep dark blue night)
4. Light tint overlay changes color per time of day
5. Clock HUD displays current time position with sun/moon indicator
6. Ambient particles change color per time of day (golden day, indigo night, pink dawn, amber dusk)
7. Corruption intensity increases during night (0 during day, ramps to 1.0 at deepest night)
8. Surface Flip modifier changes platform surfaces at night (normal→icy, icy→bouncy, etc.)
9. Player feels the surface change (e.g., ice platform becomes bouncy at night)
10. Gravity Pulse fires periodically during night (brief gravity reversal)
11. Player's jump arc noticeably affected during gravity pulse
12. Fog-of-war activates at night (visibility radius shrinks around player)
13. Fog darkens areas far from the player
14. Ink bleed particles spawn randomly during night (visual noise)
15. Platform flicker effect visible at night (platforms visually shimmer)
16. Skip-to buttons correctly advance time and update all visuals
17. Manual time scrubber allows precise time control
18. Pause/Resume toggle works (cycle stops/starts)
19. All params tunable via debug sliders
20. Cycle loops seamlessly (night → dawn → day → dusk → night → ...)

**Keyboard Controls:**
| Key | Action |
|-----|--------|
| Arrow Left/Right | Move |
| Arrow Up / Z / Space | Jump |
| Arrow Down | Crouch |
| X / Shift | Dash |
| D | Toggle debug overlays |
| T | Toggle time pause/resume |
| 1 | Skip to Dawn |
| 2 | Skip to Day |
| 3 | Skip to Dusk |
| 4 | Skip to Night |

### 6. Visual Design

**Day Atmosphere (warm, cozy, safe):**
- Background: `#f0e6d3` — warm parchment/cream
- Light tint: warm golden overlay at very low opacity
- Platforms: full brightness, warm surface-type colors
- Particles: golden dust motes drifting lazily (1-2px, slow)
- Shadows: very light (15% opacity), cast below platforms
- Feel: a sunlit library reading room

**Dawn Atmosphere (gentle awakening, corruption fading):**
- Background: `#2d1f3d` → fading to `#f0e6d3` — purple-gray to parchment
- Light tint: rosy pink
- Particles: pink/orange, a few lingering night indigo
- Shadows: moderate (30% opacity)
- Feel: first light through stained glass

**Dusk Atmosphere (warning, corruption approaching):**
- Background: `#f0e6d3` → transitioning to `#1a0f2e` — parchment to deep purple
- Light tint: amber/orange
- Particles: warm reds, oranges, hints of purple
- Shadows: growing darker (40% opacity)
- Feel: a warning bell — the library is closing

**Night Atmosphere (chaotic, dangerous, corrupted):**
- Background: `#0a0a1a` — near-black with deep blue
- Light tint: indigo overlay, cool and menacing
- Particles: cold indigo sparks, occasional white flashes
- Shadows: strong (60% opacity)
- Fog: dark overlay with visibility radius around player
- Corruption effects: surface changes, gravity pulses, ink bleed
- Feel: the library after dark — pages rewrite themselves

**Clock HUD:**
- Position: top-right corner, 24px from edges
- Size: 36px radius circle
- Border: 2px white ring
- Fill: dark background (`#1f2937`)
- Sun icon (day): small circle at the top of the dial, filled `#fbbf24` (golden)
- Moon icon (night): small crescent at the top of the dial, filled `#818cf8` (indigo)
- Progress indicator: a small bright dot traveling around the circle's edge based on `time`
- Time label below the clock: "DAWN" / "DAY" / "DUSK" / "NIGHT" in the appropriate palette color

**Fog-of-war rendering:**
- Use a full-screen overlay with `globalCompositeOperation = 'source-over'`
- Fill the entire canvas with the fog color (e.g., `rgba(10, 10, 26, 0.8)`)
- Then use `globalCompositeOperation = 'destination-out'` to cut a radial gradient circle centered on the player
- The gradient goes from fully transparent at center to fully opaque at `fogRadius`
- This creates a "spotlight" effect around the player with darkness beyond

**Corruption distortion (high corruption only):**
- At corruption > 0.5: render a very subtle chromatic aberration
- Take the current canvas content, draw it again offset by (2, 0) with `globalCompositeOperation = 'lighter'` at very low alpha (0.03)
- This creates a barely-perceptible RGB shift that signals "something is wrong"
- Only visible at high corruption to avoid being distracting

**Platform rendering at night:**
- Platforms are darkened by `platformDarkness` factor
- Draw platforms normally, then overlay a dark rect at `platformDarkness` alpha
- Surface-flipped platforms briefly flash when the flip activates (during dusk transition)
- Flickering platforms toggle their alpha between 0.4 and 1.0 randomly

**Ambient particles per time-of-day:**
- Day: small golden dust motes, drifting slowly downward with horizontal wobble. Very gentle.
- Dawn: pink/orange particles, slightly more energetic than day. A "waking up" feel.
- Dusk: warm reds and oranges, drifting faster. An urgency.
- Night: cold indigo sparks, moving erratically (random velocity changes). Some white "flash" particles that appear and disappear quickly. Corruption feeling.

Implementation: use the existing `ParticleSystem` to spawn ambient particles at a steady rate (3/sec day, 5/sec night). Each time of day uses its own color palette. The particle spawn rate and colors change as the atmosphere interpolates.

## Files to Create

- `src/engine/world/DayNightCycle.ts` — Core time management, time-of-day computation, cycle advancement
- `src/engine/world/DayNightAtmosphere.ts` — Color palettes, interpolation between time periods
- `src/engine/world/CorruptionModifiers.ts` — Night corruption effects (surface flip, gravity pulse, fog, ink bleed, platform flicker)
- `src/engine/world/DayNightRenderer.ts` — Rendering helpers for atmosphere, fog, fog-of-war, clock HUD, corruption distortion

## Files to Modify

- `src/engine/world/index.ts` — Export all day/night modules
- `src/app/test/day-night/page.tsx` — Full test page (replace stub)
- `src/lib/testStatus.ts` — Update day-night status to `'in-progress'`

## Important Implementation Notes

1. **The day/night cycle does NOT modify the Player class.** Like combat and abilities, it's a world system. The test page orchestrates: it reads `cycle.getCorruptionIntensity()` and passes it to `corruption.update()`, reads `corruption.getGravityMultiplier()` and applies it to the player's gravity param, reads `corruption.getEffectiveSurface()` and overrides platform surface types. The DayNightCycle itself just tracks time.

2. **Surface flipping in the test page.** Each frame during the update callback:
   ```
   for each platform:
     if corruption active:
       effectiveSurface = corruption.getEffectiveSurface(platform.originalSurface)
       platform.surfaceType = effectiveSurface
     else:
       platform.surfaceType = platform.originalSurface
   ```
   Store the original surface types at level creation so they can be restored during the day.

3. **Gravity pulse in the test page.** Read `corruption.getGravityMultiplier()` each frame. If it's not 1.0, temporarily override the player's gravity param:
   ```
   const gravMult = corruption.getGravityMultiplier();
   playerParamsRef.current.gravity = DEFAULT_GRAVITY * gravMult;
   ```
   The gravity pulse is brief (0.5s) and the multiplier is -0.5, meaning gravity briefly reverses at half strength. This creates a sudden "float" effect during night.

4. **Fog-of-war rendering.** This uses canvas compositing to create a radial visibility mask. The render order matters:
   - Render world (platforms, player) normally
   - After all world rendering, render the fog-of-war overlay:
     - Save canvas state
     - Fill entire canvas with fog color
     - Use `destination-out` composite to cut a radial gradient circle at the player's screen position
     - Restore canvas state
   - Then render debug overlays on top (debug should always be visible)

5. **Color interpolation.** Use linear interpolation for each RGB channel. Parse hex colors to RGB, lerp each channel, convert back. For rgba strings, also lerp the alpha. The `lerpColor()` and `lerpRgba()` helpers handle this. Don't use CSS transitions — this is canvas rendering, everything is per-frame.

6. **The cycle wraps smoothly.** When `time` reaches 1.0, it wraps to 0.0. The atmosphere interpolation near the wrap point (night→dawn) must handle the boundary — dawn starts near time=0 and night ends near time=1.0. Use the `getTimeOfDay()` method to determine which two color palettes to interpolate between, and what the interpolation progress is.

7. **Time scrubber pauses auto-advance.** When the user drags the manual time scrubber slider, set `cycle.running = false` and call `cycle.setTime(sliderValue)` directly. This allows precise time exploration. The Resume button re-enables auto-advance.

8. **Keyboard shortcuts for time.** Add temporary key bindings in the test page's update callback (not in InputManager — these are test-page-only):
   ```
   window.addEventListener('keydown', (e) => {
     if (e.key === 't') cycle.params.running = !cycle.params.running;
     if (e.key === '1') cycle.skipTo('dawn');
     if (e.key === '2') cycle.skipTo('day');
     if (e.key === '3') cycle.skipTo('dusk');
     if (e.key === '4') cycle.skipTo('night');
   });
   ```
   Clean these up on unmount.

9. **Camera follows player.** Standard camera follow with the level being 1920px wide. Set `camera.setBounds({ x: 0, y: 0, width: 1920, height: 540 })`.

10. **Corruption modifiers have activation thresholds.** Not all modifiers activate at the same corruption level:
    - Surface Flip: activates at corruption ≥ 0.3 (early night)
    - Ink Bleed: activates at corruption ≥ 0.2 (starts subtle)
    - Platform Flicker: activates at corruption ≥ 0.4 (mid-night)
    - Fog of War: activates at corruption ≥ 0.5 (deeper night)
    - Gravity Pulse: activates at corruption ≥ 0.7 (deep night only)
    These thresholds create a gradual escalation as night deepens.

11. **The clock HUD is screen-space.** Render it after resetting the camera transform, so it stays fixed on screen. Use `renderer.resetCamera()` or draw it in the `engine.onRender()` callback's screen-space section.

12. **Performance note.** The fog-of-war overlay uses canvas compositing which is fast on modern browsers. The chromatic aberration effect at high corruption uses `drawImage(canvas, offset)` which copies the canvas — this could be expensive at high resolution. Only enable it above corruption 0.5 and keep the alpha very low (0.02-0.03) so it's subtle.

13. **Ambient particles reuse ParticleSystem.** Spawn particles using `particleSystem.emit()` with different colors/velocities per time-of-day. The particle system already handles rendering and aging. Spawn at a steady rate (not all at once).

## Design Decisions (Pre-settled)

1. **120-second default cycle.** Fast enough for testing, slow enough to feel transitions. The slider goes up to 600s (10 min) for a more realistic pace.

2. **Four time-of-day phases, not a continuous gradient.** Dawn, Day, Dusk, Night are distinct phases with smooth interpolation between them. This is more readable than a pure gradient and matches the game's clear-cut "cozy day / chaotic night" divide.

3. **Corruption modifiers are world effects, not player debuffs.** They change the environment, not the player's stats directly. Surface flip changes what you're walking on. Gravity pulse is a world physics effect. Fog reduces what you can see. This reinforces the "library that rewrites itself" theme.

4. **Surface flip is the most gameplay-impactful modifier.** Normal surfaces becoming icy at night completely changes how the level plays. This is intentional — it forces the player to adapt their movement strategy for nighttime. The other modifiers are more atmospheric.

5. **Gravity pulse is rare and brief.** Only at corruption ≥ 0.7 (deep night), every 5 seconds, lasting 0.5 seconds. It's a surprise, not a constant annoyance. The reversed gravity at -0.5× is just enough to make you briefly float without flinging you off-screen.

6. **Fog-of-war uses radial gradient, not hard circle.** The soft fade at the visibility edge looks much better than a hard cutoff. The gradient creates a lantern-in-the-dark feel.

7. **Platform flicker is visual-only.** Platforms don't actually disappear — that would be too punishing. They just shimmer/flicker to create visual unease. The surface flip already provides the gameplay impact.

8. **Chromatic aberration is extremely subtle.** It's a barely-perceptible RGB shift at high corruption. Most players won't consciously notice it, but it contributes to the unsettling atmosphere. Never make it strong enough to be distracting or cause eye strain.

9. **Clock HUD is always visible.** The player needs to know what time it is so they can prepare for nightfall. The clock is small and unobtrusive but always present.

10. **Day is safe, night is challenging, transitions are atmospheric.** The design creates a clear rhythm: day is for exploration and preparation, night is for survival and dealing with corruption. Dawn and dusk are brief, beautiful transitions that signal the change.

## Verification

- [ ] `npx tsc --noEmit` passes with zero errors
- [ ] `npm run build` succeeds
- [ ] Navigate to `/test/day-night` — canvas renders with test level and player
- [ ] Day/night cycle auto-advances (watch the clock progress over 120s)
- [ ] Background color smoothly transitions: warm parchment (day) → deep purple (dusk) → dark blue-black (night) → purple-gray (dawn) → warm parchment (day)
- [ ] Light tint overlay changes per time of day (golden day, pink dawn, amber dusk, indigo night)
- [ ] Ambient particles change color palette with time of day
- [ ] Clock HUD shows time position with sun (day) or moon (night) indicator
- [ ] Corruption intensity rises during night, returns to 0 during day
- [ ] Surface Flip activates during night — icy platforms become bouncy, normal become icy, etc.
- [ ] Player feels the surface changes (movement differs on flipped surfaces)
- [ ] Gravity Pulse fires during deep night — brief gravity reversal felt in player jump
- [ ] Fog-of-war activates at night — radial visibility shrinks, areas beyond fogRadius are dark
- [ ] Ink bleed particles spawn during night — random indigo particles as visual noise
- [ ] Platform flicker visual effect during night — platforms shimmer/blink
- [ ] Skip-to buttons (1, 2, 3, 4 keys or debug panel buttons) advance to correct time
- [ ] Manual time scrubber works — drag slider to control exact time position
- [ ] Pause/Resume (T key or button) stops/starts cycle advancement
- [ ] Time Scale slider changes cycle speed in real time
- [ ] Cycle loops seamlessly from night → dawn → day → dusk → night
- [ ] All params tunable via debug sliders
- [ ] Existing movement works exactly as before — no regressions
- [ ] FPS stays at ~60fps with all effects active (fog, particles, corruption)

---

## Completion Summary

### Files Created
- `src/engine/world/DayNightCycle.ts` — Core time management system. Normalized time model (0.0-1.0), 4-phase time-of-day computation (dawn/day/dusk/night), cycle advancement with configurable duration/dayFraction/transitions, light level and corruption intensity derivation, atmosphere color interpolation, skip-to and manual time control APIs.
- `src/engine/world/DayNightAtmosphere.ts` — Color palettes for all 4 time periods (DAY_COLORS, NIGHT_COLORS, DAWN_COLORS, DUSK_COLORS), hex/rgba color parsing and interpolation utilities (lerpColor, lerpRgba), DayNightAtmosphere interface with backgroundColor/lightTint/fogColor/platformDarkness/shadowOpacity/corruptionIntensity.
- `src/engine/world/CorruptionModifiers.ts` — 5 corruption modifier types (surface-flip, gravity-pulse, fog-of-war, ink-bleed, platform-flicker) with staggered activation thresholds (0.2-0.7). Gravity pulse timer with brief reversal. Fog radius interpolation. Platform flicker random per-frame. Ink bleed particle spawning with accumulator. Surface flip map for cycling surface types.
- `src/engine/world/DayNightRenderer.ts` — Static rendering helpers: background fill, light tint overlay, fog overlay, fog-of-war radial gradient mask (destination-out compositing), clock HUD with sun/moon icons and progress arc, corruption chromatic aberration distortion, platform darkness overlay, platform shadow rendering.

### Files Modified
- `src/engine/world/index.ts` — Added exports for all 4 new day/night modules
- `src/app/test/day-night/page.tsx` — Full test page replacing stub. 1920x540 level with varied surfaces (normal, icy, bouncy, sticky, conveyor), player movement, camera follow with bounds, day/night cycle integration with corruption modifiers. Debug panel with Cycle Info readouts, Time Controls (sliders + skip-to buttons + pause/resume + manual time scrubber), Corruption Modifiers section, Visual Settings toggles, Player Movement section. Keyboard shortcuts (T=pause, 1-4=skip). Ambient particles per time-of-day. Surface flip applies to platforms at night. Gravity pulse reversal during deep night. Fog-of-war radial visibility. Ink bleed particles. Platform flicker effect.
- `src/lib/testStatus.ts` — Updated Day/Night Cycle status to `'in-progress'`

### Verification
- `npx tsc --noEmit` — passes with zero errors
- `npm run build` — succeeds, all routes including `/test/day-night` build correctly

---

## Review (d19fee5e)

### Issues Found & Fixed

**1. Fog-of-war compositing bug (DayNightRenderer.ts) — CRITICAL**
The `renderFogOfWar` method used `destination-out` compositing directly on the main canvas. This destroyed all previously rendered game content (background, platforms, player) at the center of the spotlight, creating transparent holes instead of a visibility effect. Fixed by replacing the two-pass source-over/destination-out approach with a single radial gradient that goes from transparent (at player center) to the fog color (at the fog radius and beyond). This correctly overlays darkness without destroying underlying pixels.

**2. Gravity pulse had no effect on player (page.tsx) — CRITICAL**
The gravity pulse code set `player.params.gravity` but the Player class never reads `params.gravity` — its state machine uses `params.riseGravity` and `params.fallGravity` instead. The only thing affecting the player was a hacky velocity manipulation (`player.velocity.y -= ...`) with a magic number (`* 3`) and an arbitrary cap (`-200`). Fixed by:
- Storing base `riseGravity`/`fallGravity` values in engine refs
- During pulse, setting `player.params.riseGravity` and `player.params.fallGravity` to `base * gravityMultiplier` (negative multiplier reverses gravity naturally)
- Restoring base values when pulse ends
- Removed the velocity hack entirely

**3. Debug gravity slider was ineffective (page.tsx) — MINOR**
The debug panel had a single "Gravity" slider controlling `params.gravity` which is unused. Replaced with separate "Rise Gravity" and "Fall Gravity" sliders (matching the movement playground pattern) that modify `params.riseGravity`/`params.fallGravity` and update the stored base values for gravity pulse restoration.

**4. Removed unused `DEFAULT_GRAVITY` import (page.tsx) — CLEANUP**
After fixing the gravity pulse, `DEFAULT_GRAVITY` was no longer used in the test page. Removed the import.

### Items Reviewed — No Issues

- **DayNightCycle.ts**: Time model correct. Phase boundaries compute correctly. Corruption intensity uses sine curve peaking at midnight. Cycle wraps properly. `setTime`/`skipTo`/`reset` all update derived state.
- **DayNightAtmosphere.ts**: Color parsing handles both hex and rgba. Lerp functions correct. `interpolateColors` properly clamps t.
- **CorruptionModifiers.ts**: Staggered thresholds correct (ink-bleed 0.2 → gravity-pulse 0.7). Gravity pulse timer scales inversely with corruption. Platform flicker uses Math.random per-frame (visual-only, not gameplay-affecting). Ink bleed accumulator pattern correct.
- **DayNightRenderer.ts** (other methods): Background, light overlay, fog, clock HUD, corruption distortion, platform darkness/shadow all correct. Clock HUD renders sun/moon correctly per time-of-day.
- **world/index.ts**: All exports present and correctly typed.
- **testStatus.ts**: Day/Night Cycle status correctly set to `'in-progress'`.
- **Test page structure**: Follows established patterns (useCallback for mount/unmount, refs for engine-React bridge, throttled UI updates). Keyboard shortcuts properly cleaned up on unmount. Camera bounds correct. Surface flip restores originals during day.

### Post-Review Verification
- `npx tsc --noEmit` — passes
- `npm run build` — succeeds
