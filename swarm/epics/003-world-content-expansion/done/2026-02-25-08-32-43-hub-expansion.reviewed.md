# Hub Expansion — Wire All Wings into Scribe Hall + Complete World Graph Registration

## Goal

Expand the Scribe Hall hub with exits to all biome wings, register the Maritime Ledger wing in the world graph, wire missing shrine rooms into the world graph and factory, and add missing bidirectional exits between shrine rooms and their parent wing rooms. After this task, every room in the game is reachable from the Scribe Hall hub.

---

## Context

### What exists today

- **Scribe Hall** (`src/engine/world/scribeHall.ts`) is a 1920×1080 room with 2 exits:
  - Left → `tutorial-corridor` (Herbarium Wing entry)
  - Right → `archive-passage` (Central Archives entry)
- **Maritime Ledger Wing** (`maritimeLedgerRooms.ts`) — 7 rooms fully built, exports `MARITIME_LEDGER_ROOMS` and `MARITIME_LEDGER_ROOM_IDS`. Harbor-approach already has a left exit targeting `scribe-hall` with spawn `(1920-80, 1080-64-T)`. But Scribe Hall has **no return exit** to `harbor-approach`, and the Maritime Ledger wing is **not registered in `demoWorld.ts`** (not in the world graph data, not in the factory function).
- **Gothic Errata Wing** (`gothicErrataRooms.ts`) — being built by another agent. Already imported and registered in `demoWorld.ts`. The `crypt-entrance` room connects to `upper-archives` (Central Archives).
- **Astral Atlas Wing** (`astralAtlasRooms.ts`) — fully built and registered in `demoWorld.ts`. Connects via `observatory-bridge` ↔ `upper-archives`.
- **Central Archives** — fully built, 5 rooms. `upper-archives` has exits to `observatory-bridge` (Astral Atlas) and `crypt-entrance` (Gothic Errata).
- **Shrine rooms** (`abilityShrineRooms.ts`) — all 4 defined, but only `paste-shrine` and `index-shrine` are registered in the world graph/factory. **`stitch-shrine` and `redaction-shrine` are NOT in the world graph or factory.**
- **Missing bidirectional exit**: `stitch-shrine` has a top exit to `vine-vestibule`, but `vine-vestibule` has NO exit to `stitch-shrine`. Similarly, `redaction-shrine` connects to `cargo-hold` and `storm-channel` in Maritime Ledger — those connections already exist in `maritimeLedgerRooms.ts`.

### Design decisions

1. **Hub exit placement**: Add a bottom exit from Scribe Hall to `harbor-approach` (Maritime Ledger). The floor platform needs a gap for the exit zone. This follows the epic spec: "bottom → harbor-approach".
2. **No additional hub exits needed**: Astral Atlas and Gothic Errata are accessed through Central Archives (via `upper-archives`), not directly from the hub. The hub only needs left (Herbarium), right (Archives), and bottom (Maritime Ledger).
3. **Vine Vestibule needs a bottom exit to stitch-shrine**: The shrine's top exit already targets vine-vestibule, so just add the return path.
4. **Maritime Ledger region**: Add to `DEMO_WORLD_DATA.regions` including `redaction-shrine` (same pattern as paste-shrine in Astral Atlas).

---

## Files to Modify

### 1. `src/engine/world/scribeHall.ts` — Add bottom exit to Maritime Ledger

**Changes:**
- Create a gap in the floor platform for the bottom exit zone
- Split the floor from one full-width platform into two segments with a gap in the center
- Add a bottom exit zone in the floor gap targeting `harbor-approach`
- The exit should be center-bottom of the room

**Specific edits:**

Replace the full-width floor:
```typescript
{ x: 0, y: 1080 - T, width: 1920, height: T },
```

With two segments and a gap (160px wide gap centered):
```typescript
// Floor (left segment)
{ x: 0, y: 1080 - T, width: 880, height: T },
// Floor (right segment)
{ x: 1040, y: 1080 - T, width: 880, height: T },
```

Add new exit to the `exits` array:
```typescript
// Bottom exit → Harbor Approach (Maritime Ledger Wing)
{
  direction: "bottom",
  zone: { x: 880, y: 1080 - EXIT_ZONE_DEPTH, width: 160, height: EXIT_ZONE_DEPTH },
  targetRoomId: "harbor-approach",
  targetSpawnPoint: { x: 64, y: 540 - 64 - T },
},
```

**Important:** Import `EXIT_ZONE_DEPTH` from `./Room`.

### 2. `src/engine/world/herbariumRooms.ts` — Add vine-vestibule exit to stitch-shrine

**Changes:**
- Add a bottom exit to `vine-vestibule` targeting `stitch-shrine`
- The exit should be at the bottom of the room

Add to vine-vestibule's `exits` array:
```typescript
// Bottom → Stitch Sanctum (ability shrine)
{
  direction: "bottom",
  zone: { x: 400, y: 1080 - EXIT_ZONE_DEPTH, width: 160, height: EXIT_ZONE_DEPTH },
  targetRoomId: "stitch-shrine",
  targetSpawnPoint: { x: 480, y: 1080 - 64 - T },
},
```

**Note:** Vine vestibule has a full floor platform `{ x: 0, y: 1080 - T, width: 960, height: T }`. Need to split it to create a gap for the bottom exit:
```typescript
// Floor (left segment)
{ x: 0, y: 1080 - T, width: 400, height: T },
// Floor (right segment)
{ x: 560, y: 1080 - T, width: 400, height: T },
```

### 3. `src/engine/world/demoWorld.ts` — Register Maritime Ledger + missing shrines

**Changes:**

**Add import:**
```typescript
import { MARITIME_LEDGER_ROOMS, MARITIME_LEDGER_ROOM_IDS } from "./maritimeLedgerRooms";
```

**Add Maritime Ledger region to `DEMO_WORLD_DATA.regions`:**
```typescript
{
  id: "maritime-ledger-wing",
  name: "Maritime Ledger Wing",
  biomeId: "maritime-ledger",
  roomIds: [...MARITIME_LEDGER_ROOM_IDS, "redaction-shrine"],
},
```

**Add `stitch-shrine` to the herbarium-wing region's roomIds:**
Change:
```typescript
roomIds: ["tutorial-corridor", "vine-garden", ...HERBARIUM_WING_ROOM_IDS],
```
To:
```typescript
roomIds: ["tutorial-corridor", "vine-garden", "stitch-shrine", ...HERBARIUM_WING_ROOM_IDS],
```

**Add to `createDemoWorld()` factory:**
```typescript
// Maritime Ledger Wing
for (const [id, room] of Object.entries(MARITIME_LEDGER_ROOMS)) {
  rooms.set(id, room);
}

// Register all shrine rooms (stitch-shrine and redaction-shrine)
if (ABILITY_SHRINE_ROOMS["stitch-shrine"]) {
  rooms.set("stitch-shrine", ABILITY_SHRINE_ROOMS["stitch-shrine"]);
}
if (ABILITY_SHRINE_ROOMS["redaction-shrine"]) {
  rooms.set("redaction-shrine", ABILITY_SHRINE_ROOMS["redaction-shrine"]);
}
```

### 4. `src/app/test/world-assembly/page.tsx` — Verify the new rooms are accessible

No code changes needed here, but the developer should verify that the world-assembly test page works with the expanded world graph (more rooms, new regions).

---

## Verification Checklist

After making all changes, verify:

1. **TypeScript compiles**: `npx tsc --noEmit` passes with no errors
2. **Scribe Hall has 3 exits**: left (tutorial-corridor), right (archive-passage), bottom (harbor-approach)
3. **Harbor Approach → Scribe Hall** bidirectional: harbor-approach's left exit targets scribe-hall, scribe-hall's bottom exit targets harbor-approach
4. **Vine Vestibule → Stitch Shrine** bidirectional: vine-vestibule has bottom exit to stitch-shrine, stitch-shrine has top exit to vine-vestibule
5. **Maritime Ledger region** appears in world graph data with all 8 room IDs (7 wing rooms + redaction-shrine)
6. **All shrine rooms** are in the factory function: stitch-shrine, redaction-shrine, paste-shrine, index-shrine
7. **All shrine rooms** are in a world graph region: stitch-shrine in herbarium-wing, redaction-shrine in maritime-ledger-wing, paste-shrine in astral-atlas-wing, index-shrine in gothic-errata-wing
8. **Every exit's targetRoomId** resolves to a room in the factory Map
9. **Every exit has a bidirectional return** in the target room

## Pass Criteria

- Scribe Hall has exits to all wing entry points (directly or via Central Archives)
- Player can reach every biome wing from the hub
- Maritime Ledger Wing rooms are fully registered in the world graph
- All 4 ability shrine rooms are registered and reachable
- No dangling exits (every targetRoomId exists in the room map)
- TypeScript compiles cleanly

---

## Implementation Summary

### Files Changed

1. **`src/engine/world/scribeHall.ts`**
   - Added `EXIT_ZONE_DEPTH` import from `./Room`
   - Split full-width floor platform into two segments with 160px centered gap (880 + 880)
   - Added bottom exit → `harbor-approach` with spawn at `(64, 540-64-T)`

2. **`src/engine/world/herbariumRooms.ts`**
   - Split vine-vestibule's full floor platform into two segments with 160px centered gap (400 + 400)
   - Added bottom exit → `stitch-shrine` with spawn at `(480, 1080-64-T)`

3. **`src/engine/world/demoWorld.ts`**
   - Added import for `MARITIME_LEDGER_ROOMS` and `MARITIME_LEDGER_ROOM_IDS`
   - Added `stitch-shrine` to herbarium-wing region roomIds
   - Added maritime-ledger-wing region with 7 wing rooms + `redaction-shrine`
   - Added Maritime Ledger rooms to factory (loop over `MARITIME_LEDGER_ROOMS`)
   - Added `stitch-shrine` and `redaction-shrine` to factory

### Verification Results

- `npx tsc --noEmit` passes with zero errors
- Scribe Hall has 3 exits: left (tutorial-corridor), right (archive-passage), bottom (harbor-approach)
- Harbor Approach ↔ Scribe Hall: bidirectional (left exit ↔ bottom exit)
- Vine Vestibule ↔ Stitch Shrine: bidirectional (bottom exit ↔ top exit)
- Maritime Ledger region has 8 room IDs (7 wing + redaction-shrine)
- All 4 shrine rooms registered in both world graph regions and factory map
- All exits have bidirectional returns

---

## Review Notes (a7e3140d)

**Reviewed all 3 modified files. No issues found — no fixes needed.**

Verified:
- scribeHall.ts: Floor split is geometrically correct (880+160+880=1920). Exit zone covers the gap. EXIT_ZONE_DEPTH imported properly.
- herbariumRooms.ts: Vine Vestibule floor split correct (400+160+400=960). Bottom exit zone covers gap. Stitch shrine spawn point is valid.
- demoWorld.ts: Maritime Ledger import, region registration, and factory additions all correct. All 4 shrine rooms present in both world graph regions and factory map.
- Bidirectional exits: Scribe Hall ↔ Harbor Approach and Vine Vestibule ↔ Stitch Shrine both verified. Spawn points land on valid floor surfaces.
- TypeScript: `npx tsc --noEmit` passes cleanly with zero errors.
